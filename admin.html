<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Dashboard Admin AKITA</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="icon" type="image/png" href="icon.png" />
    <link rel="icon" type="image/png" href="icon.png" />
    <link rel="shortcut icon" href="icon.png" />
    <link rel="apple-touch-icon" href="icon.png" />

    <!-- Favicon standar untuk desktop -->
    <link rel="icon" type="image/png" href="icon.png" />
    <link rel="shortcut icon" href="icon.png" />

    <!-- iOS icons -->
    <link rel="apple-touch-icon" href="icon.png" />
    <link rel="apple-touch-icon-precomposed" href="icon.png" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="apple-mobile-web-app-title" content="Akita" />

    <!-- Android icons -->
    <link rel="manifest" href="manifest.json" />
    <meta name="mobile-web-app-title" content="Akita" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="theme-color" content="#3f51b5" />
    <style>
      .chart-container {
        position: relative;
        height: 280px;
        margin: 15px 0;
      }

      .chart-filters {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        flex-wrap: wrap;
      }

      .chart-filters select {
        padding: 6px 10px;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        background: white;
        font-size: 13px;
        cursor: pointer;
        min-width: 120px;
      }

      .chart-filters select:focus {
        outline: none;
        border-color: #667eea;
      }

      @media (max-width: 768px) {
        .chart-container {
          height: 220px;
        }

        .chart-filters {
          justify-content: center;
          gap: 8px;
        }

        .chart-filters select {
          font-size: 12px;
          padding: 5px 8px;
          min-width: 100px;
        }
      }

      /* Dashboard specific styles */
      .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 15px;
        margin-bottom: 15px;
      }

      @media (max-width: 768px) {
        .dashboard-grid {
          grid-template-columns: 1fr;
          gap: 12px;
        }

        .dashboard-grid .card {
          margin-bottom: 12px;
        }
      }

      /* Ensure proper spacing for dashboard elements */
      #dashboard .card {
        margin-bottom: 15px;
      }

      #dashboard .stats-grid {
        margin-bottom: 20px;
      }

      /* PIC Analysis Grid */
      .pic-analysis-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }

      @media (max-width: 768px) {
        .pic-analysis-grid {
          grid-template-columns: 1fr;
          gap: 12px;
        }
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
      }

      .sidebar {
        width: 250px;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-right: 1px solid rgba(255, 255, 255, 0.2);
        padding: 20px;
        height: 100vh;
        position: fixed;
        left: 0;
        top: 0;
        z-index: 1000;
        transition: transform 0.3s ease;
      }

      .sidebar h2 {
        color: #fff;
        font-size: 24px;
        margin-bottom: 30px;
        text-align: center;
        font-weight: 600;
      }

      .sidebar a {
        display: block;
        color: #fff;
        text-decoration: none;
        margin-bottom: 15px;
        padding: 12px 16px;
        border-radius: 12px;
        transition: all 0.3s ease;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .sidebar a:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: translateX(5px);
      }

      .sidebar a.active {
        background: rgba(255, 255, 255, 0.3);
        border-color: rgba(255, 255, 255, 0.4);
      }

      .main-content {
        flex: 1;
        margin-left: 250px;
        padding: 20px;
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(5px);
        min-height: 100vh;
      }

      .header {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 30px;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .header h1 {
        color: #fff;
        font-size: 28px;
        margin-bottom: 10px;
      }

      .header p {
        color: rgba(255, 255, 255, 0.8);
        font-size: 16px;
      }

      .content-section {
        display: none;
      }

      .content-section.active {
        display: block;
      }

      .card {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 12px;
        padding: 18px;
        margin-bottom: 15px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .card h2 {
        color: #333;
        margin-bottom: 15px;
        font-size: 20px;
        font-weight: 600;
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        color: #555;
        font-weight: 500;
      }

      .form-group input,
      .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.3s ease;
      }

      .form-group input:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #667eea;
      }

      .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-right: 10px;
      }

      .btn-primary {
        background: #667eea;
        color: #fff;
      }

      .btn-primary:hover {
        background: #5a6fd8;
        transform: translateY(-2px);
      }

      .btn-secondary {
        background: #6c757d;
        color: #fff;
      }

      .btn-secondary:hover {
        background: #5a6268;
      }

      .btn-danger {
        background: #dc3545;
        color: #fff;
      }

      .btn-danger:hover {
        background: #c82333;
      }

      .btn-warning {
        background: #ffc107;
        color: #212529;
      }

      .btn-warning:hover {
        background: #e0a800;
      }

      .table-container {
        overflow-x: auto;
        border-radius: 10px;
        background: #fff;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
      }

      th {
        background: #667eea;
        color: #fff;
        padding: 15px;
        text-align: left;
        font-weight: 600;
      }

      td {
        padding: 12px 15px;
        border-bottom: 1px solid #e0e0e0;
      }

      tr:hover {
        background: #f8f9ff;
      }

      .filter-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }

      .tab {
        padding: 10px 20px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 25px;
        background: rgba(255, 255, 255, 0.1);
        color: #000;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
      }

      .tab:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      .tab.active {
        background: rgba(255, 255, 255, 0.3);
        border-color: rgba(0, 0, 0, 0.5);
      }

      .hidden {
        display: none;
      }

      .form-row {
        display: flex;
        gap: 15px;
        margin-bottom: 15px;
      }

      .form-row .form-group {
        flex: 1;
        margin-bottom: 0;
      }

      .edit-form {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 12px;
        padding: 20px;
        margin-top: 20px;
        border: 1px solid rgba(255, 255, 255, 0.3);
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 25px;
      }

      .stat-card {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 12px;
        padding: 25px 20px;
        text-align: center;
        border: 1px solid rgba(255, 255, 255, 0.2);
        min-height: 120px;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }

      .stat-card h3 {
        color: #fff;
        font-size: 22px;
        margin-bottom: 8px;
        font-weight: 600;
      }

      .stat-card p {
        color: rgba(255, 255, 255, 0.8);
        font-size: 13px;
      }

      /* Toast Notifications */
      .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10000;
      }

      .toast {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 12px;
        padding: 16px 20px;
        margin-bottom: 10px;
        border-left: 4px solid #28a745;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        transform: translateX(400px);
        opacity: 0;
        transition: all 0.3s ease;
        min-width: 300px;
      }

      .toast.show {
        transform: translateX(0);
        opacity: 1;
      }

      .toast.error {
        border-left-color: #dc3545;
      }

      .toast.warning {
        border-left-color: #ffc107;
      }

      .toast-content {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .toast-icon {
        font-size: 20px;
      }

      .toast-message {
        color: #333;
        font-weight: 500;
        flex: 1;
      }

      .toast-close {
        background: none;
        border: none;
        font-size: 18px;
        cursor: pointer;
        color: #666;
        opacity: 0.7;
      }

      .toast-close:hover {
        opacity: 1;
      }

      /* Loading States */
      .btn.loading {
        position: relative;
        pointer-events: none;
        opacity: 0.7;
      }

      .btn.loading::before {
        content: "";
        position: absolute;
        left: 50%;
        top: 50%;
        width: 16px;
        height: 16px;
        margin: -8px 0 0 -8px;
        border: 2px solid transparent;
        border-top: 2px solid currentColor;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }

        100% {
          transform: rotate(360deg);
        }
      }

      .table-loading {
        position: relative;
        pointer-events: none;
        opacity: 0.6;
      }

      .table-loading::after {
        content: "Memuat data...";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(255, 255, 255, 0.9);
        padding: 20px;
        border-radius: 8px;
        font-weight: 500;
        color: #666;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      }

      /* Search Functionality */
      .search-container {
        margin-bottom: 20px;
        position: relative;
      }

      .search-box {
        width: 100%;
        max-width: 400px;
        padding: 12px 16px 12px 45px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 25px;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        color: #000;
        font-size: 14px;
        transition: all 0.3s ease;
      }

      .search-box:focus {
        outline: none;
        border-color: rgba(255, 255, 255, 0.5);
        background: rgba(255, 255, 255, 0.2);
      }

      .search-box::placeholder {
        color: rgba(0, 0, 0, 0.6);
      }

      .search-icon {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: rgba(0, 0, 0, 0.6);
        font-size: 16px;
      }

      .search-clear {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: rgba(0, 0, 0, 0.6);
        cursor: pointer;
        font-size: 18px;
        display: none;
      }

      .search-clear:hover {
        color: rgba(0, 0, 0, 0.8);
      }

      .highlight {
        background-color: #ffeb3b;
        padding: 2px 4px;
        border-radius: 3px;
        font-weight: 600;
      }

      .no-results {
        text-align: center;
        padding: 40px 20px;
        color: #666;
        font-style: italic;
      }

      .no-results-icon {
        font-size: 48px;
        margin-bottom: 10px;
        opacity: 0.5;
      }

      .search-stats {
        margin-top: 10px;
        font-size: 12px;
        color: rgba(0, 0, 0, 0.6);
      }

      /* Hamburger Menu Button */
      .hamburger-btn {
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 1001;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        width: 45px;
        height: 45px;
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .hamburger-btn:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      .hamburger-btn span {
        width: 20px;
        height: 2px;
        background: #fff;
        margin: 2px 0;
        transition: all 0.3s ease;
        border-radius: 2px;
      }

      .hamburger-btn.active span:nth-child(1) {
        transform: rotate(45deg) translate(4px, 4px);
      }

      .hamburger-btn.active span:nth-child(2) {
        opacity: 0;
      }

      .hamburger-btn.active span:nth-child(3) {
        transform: rotate(-45deg) translate(4px, -4px);
      }

      /* Sidebar Overlay */
      .sidebar-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
        z-index: 999;
        display: none;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .sidebar-overlay.active {
        display: block;
        opacity: 1;
      }

      /* Responsive Design */
      @media (max-width: 1024px) {
        .hamburger-btn {
          display: flex;
        }

        .sidebar {
          transform: translateX(-100%);
        }

        .sidebar.active {
          transform: translateX(0);
        }

        .main-content {
          margin-left: 0;
          padding: 80px 20px 20px;
        }

        .stats-grid {
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 15px;
        }

        .form-row {
          flex-direction: column;
          gap: 0;
        }
      }

      @media (max-width: 768px) {
        .main-content {
          padding: 80px 15px 15px;
        }

        .header h1 {
          font-size: 24px;
        }

        .card {
          padding: 20px;
        }

        .table-container {
          overflow-x: auto;
        }

        .filter-tabs {
          flex-wrap: wrap;
          gap: 8px;
        }

        .tab {
          padding: 8px 16px;
          font-size: 14px;
        }

        .search-box {
          max-width: 100%;
        }

        .stats-grid {
          grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
          gap: 10px;
        }

        .stat-card {
          padding: 15px;
        }

        .stat-card h3 {
          font-size: 20px;
        }

        th,
        td {
          padding: 8px;
          font-size: 12px;
        }

        .btn {
          padding: 8px 12px;
          font-size: 12px;
          margin: 2px;
        }

        .stats-grid {
          grid-template-columns: 1fr 1fr;
          gap: 15px;
        }

        .stat-card {
          padding: 20px 15px;
          min-height: 100px;
        }

        .stat-card h3 {
          font-size: 26px !important;
          margin-bottom: 8px;
        }

        .stat-card p {
          font-size: 14px !important;
        }

        .card {
          padding: 20px !important;
        }

        .card h2 {
          font-size: 18px !important;
        }

        .btn {
          padding: 10px 16px !important;
          font-size: 14px !important;
          margin: 3px !important;
        }

        th,
        td {
          padding: 10px 8px !important;
          font-size: 13px !important;
        }
      }

      /* Text truncation for mobile tables */
      .table-container {
        overflow-x: visible;
      }

      table {
        table-layout: fixed;
        width: 100%;
      }

      td:nth-child(3) {
        /* Kolom Agenda */
        max-width: 120px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      td:nth-child(4) {
        /* Kolom PIC */
        max-width: 80px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      td:nth-child(5) {
        /* Kolom Tempat */
        max-width: 80px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      td:nth-child(6) {
        /* Kolom Aksi */
        min-width: 120px;
        text-align: center;
      }

      td:nth-child(6) .btn {
        display: block !important;
        width: 100% !important;
        margin: 2px 0 !important;
        padding: 8px 6px !important;
        font-size: 11px !important;
      }

      /* Hover to show full text on mobile */
      td:hover {
        overflow: visible;
        white-space: normal;
        word-wrap: break-word;
        position: relative;
        z-index: 10;
        background: #fff;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      }

      @media (max-width: 480px) {
        th {
          padding: 8px 6px !important;
          font-size: 12px !important;
          font-weight: 600 !important;
        }
        .stat-card h3 {
          font-size: 28px !important;
          margin-bottom: 6px !important;
        }

        .stat-card p {
          font-size: 13px !important;
        }
        .search-container {
          margin-bottom: 15px !important;
        }

        .search-box {
          padding: 12px 16px 12px 40px !important;
          font-size: 14px !important;
          border-radius: 20px !important;
        }

        .search-icon {
          left: 12px !important;
          font-size: 14px !important;
        }
        .header {
          padding: 15px !important;
          margin-bottom: 20px !important;
        }

        .header h1 {
          font-size: 20px !important;
        }

        .header p {
          font-size: 14px !important;
        }
        .main-content {
          padding: 80px 15px 15px !important;
        }

        .header {
          padding: 20px !important;
        }

        .header h1 {
          font-size: 22px !important;
        }

        .card {
          padding: 20px !important;
          margin-bottom: 20px !important;
        }

        .card h2 {
          font-size: 20px !important;
          margin-bottom: 15px !important;
        }

        .stats-grid {
          grid-template-columns: 1fr !important;
          gap: 15px !important;
        }

        .stat-card {
          padding: 25px 20px !important;
          min-height: 100px !important;
        }

        .stat-card h3 {
          font-size: 32px !important;
          margin-bottom: 10px !important;
        }

        .stat-card p {
          font-size: 16px !important;
        }

        .filter-tabs {
          justify-content: center;
          flex-wrap: wrap;
        }

        .tab {
          padding: 12px 20px !important;
          font-size: 14px !important;
          margin: 5px !important;
        }

        .search-box {
          padding: 15px 16px 15px 45px !important;
          font-size: 16px !important;
        }

        .table-container {
          border-radius: 8px;
          font-size: 14px !important;
        }

        th,
        td {
          padding: 12px 8px !important;
          font-size: 14px !important;
        }

        .btn {
          padding: 10px 15px !important;
          font-size: 13px !important;
          margin: 3px !important;
          display: inline-block !important;
        }

        .form-group input,
        .form-group textarea {
          padding: 15px !important;
          font-size: 16px !important;
        }

        .form-group label {
          font-size: 14px !important;
          margin-bottom: 8px !important;
        }

        .toast {
          min-width: 280px;
          margin: 0 10px;
          font-size: 14px !important;
        }

        .chart-container {
          height: 250px !important;
          margin: 15px 0 !important;
        }

        .chart-filters select {
          padding: 12px 15px !important;
          font-size: 14px !important;
          min-width: auto !important;
          width: 100% !important;
          margin-bottom: 10px !important;
        }

        td:nth-child(3) {
          /* Kolom Agenda */
          max-width: 100px !important;
        }

        td:nth-child(4) {
          /* Kolom PIC */
          max-width: 60px !important;
        }

        td:nth-child(5) {
          /* Kolom Tempat */
          max-width: 60px !important;
        }
      }

      .legend-scale {
        display: flex;
        gap: 2px;
      }

      .legend-item {
        width: 12px;
        height: 12px;
        border-radius: 2px;
      }

      .insight-card {
        background: linear-gradient(45deg, #f093fb 0%, #f5576c 100%);
        color: white;
        padding: 20px;
        border-radius: 12px;
        margin: 10px 0;
      }

      .insight-title {
        font-size: 16px;
        font-weight: bold;
        margin-bottom: 10px;
      }

      .insight-text {
        font-size: 14px;
        opacity: 0.9;
      }

      .metric-comparison {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin: 20px 0;
      }

      .metric-item {
        text-align: center;
        padding: 15px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        backdrop-filter: blur(5px);
      }

      .metric-value {
        font-size: 24px;
        font-weight: bold;
        color: #333;
        margin-bottom: 5px;
      }

      .metric-label {
        font-size: 12px;
        color: #666;
        text-transform: uppercase;
      }

      .filter-tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 20px;
        justify-content: center;
        align-items: center;
        flex-wrap: wrap;
        padding: 0 10px;
      }

      .tab {
        padding: 12px 20px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 25px;
        background: rgba(255, 255, 255, 0.1);
        color: #000;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
        font-size: 14px;
        white-space: nowrap;
        text-align: center;
        backdrop-filter: blur(10px);
        min-width: fit-content;
      }

      .tab:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: translateY(-2px);
      }

      .tab.active {
        background: rgba(255, 255, 255, 0.3);
        border-color: rgba(0, 0, 0, 0.5);
        color: #333;
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .status-badge {
        padding: 4px 12px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: 500;
        text-align: center;
        min-width: 80px;
        display: inline-block;
      }

      .status-selesai {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .status-ditunda {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }

      .status-batal {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .status-belum_selesai {
        background: #e2e3e5;
        color: #383d41;
        border: 1px solid #d6d8db;
      }

      /* Form Select Styles */
      .form-group select {
        width: 100%;
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 14px;
        background: white;
        cursor: pointer;
        transition: border-color 0.3s ease;
      }

      .form-group select:focus {
        outline: none;
        border-color: #667eea;
      }

      /* File Input Styles */
      .form-group input[type="file"] {
        padding: 8px;
        border: 2px dashed #e0e0e0;
        background: #f9f9f9;
        cursor: pointer;
      }

      .form-group input[type="file"]:hover {
        border-color: #667eea;
        background: #f0f4ff;
      }

      /* Current Foto Preview */
      .current-foto {
        margin-top: 10px;
        padding: 10px;
        background: #f9f9f9;
        border-radius: 8px;
        border: 1px solid #e0e0e0;
      }

      .current-foto p {
        margin-bottom: 8px;
        font-size: 13px;
        color: #666;
      }

      .btn-info {
        background: #17a2b8;
        color: #fff;
      }

      .btn-info:hover {
        background: #138496;
      }

      /* Mobile Responsive for Status */
      @media (max-width: 768px) {
        .status-badge {
          font-size: 11px;
          padding: 3px 8px;
          min-width: 70px;
        }

        td:nth-child(5) {
          min-width: 90px;
        }
      }

      /* Print PDF Styles */
      .pdf-content {
        font-family: "Arial", sans-serif;
        line-height: 1.6;
        color: #333;
        max-width: 800px;
        margin: 0 auto;
      }

      .pdf-header {
        text-align: center;
        border-bottom: 3px solid #667eea;
        padding-bottom: 20px;
        margin-bottom: 30px;
      }

      .pdf-header h1 {
        color: #667eea;
        font-size: 24px;
        margin-bottom: 10px;
      }

      .pdf-section {
        margin-bottom: 25px;
      }

      .pdf-section h3 {
        background: #f8f9fa;
        padding: 12px 15px;
        border-left: 4px solid #667eea;
        margin-bottom: 15px;
        font-size: 16px;
      }

      .pdf-field {
        display: flex;
        margin-bottom: 12px;
        padding: 8px 0;
      }

      .pdf-label {
        font-weight: bold;
        width: 150px;
        color: #555;
      }

      .pdf-value {
        flex: 1;
        color: #333;
      }

      .pdf-status-badge {
        display: inline-block;
        padding: 6px 15px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
        text-transform: uppercase;
      }

      .pdf-foto {
        text-align: center;
        margin: 20px 0;
      }

      .pdf-foto img {
        max-width: 400px;
        max-height: 300px;
        border: 1px solid #ddd;
        border-radius: 8px;
      }

      .pdf-footer {
        margin-top: 40px;
        padding-top: 20px;
        border-top: 1px solid #ddd;
        text-align: center;
        font-size: 12px;
        color: #666;
      }
      .btn-print {
        margin-left: 10px;
      }
      .chart-filters button {
  padding: 6px 12px;
  border: none;
  border-radius: 6px;
  background: #17a2b8;
  color: white;
  font-size: 13px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.chart-filters button:hover {
  background: #138496;
  transform: translateY(-2px);
}

/* Room Availability Styles */
.room-card {
  background: #fff;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 15px;
  border: 2px solid #e0e0e0;
  transition: all 0.3s ease;
}

.room-card:hover {
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  transform: translateY(-2px);
}

.room-card.available {
  border-color: #28a745;
  background: linear-gradient(135deg, #f0fff4 0%, #fff 100%);
}

.room-card.occupied {
  border-color: #dc3545;
  background: linear-gradient(135deg, #fff5f5 0%, #fff 100%);
}

.room-card.upcoming {
  border-color: #ffc107;
  background: linear-gradient(135deg, #fffbf0 0%, #fff 100%);
}

.room-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.room-name {
  font-size: 18px;
  font-weight: 600;
  color: #333;
}

.room-status {
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 500;
}

.status-available {
  background: #28a745;
  color: white;
}

.status-occupied {
  background: #dc3545;
  color: white;
}

.status-upcoming {
  background: #ffc107;
  color: #333;
}

.room-schedule {
  margin-top: 10px;
}

.schedule-item {
  padding: 10px;
  background: rgba(0,0,0,0.03);
  border-radius: 8px;
  margin-bottom: 8px;
  font-size: 13px;
}

.schedule-time {
  font-weight: 600;
  color: #667eea;
  margin-bottom: 4px;
}

.schedule-agenda {
  color: #333;
  margin-bottom: 2px;
}

.schedule-pic {
  color: #666;
  font-size: 12px;
}

.empty-schedule {
  text-align: center;
  padding: 20px;
  color: #999;
  font-style: italic;
}

@media (max-width: 768px) {
  .room-card {
    padding: 15px;
  }
  
  .room-name {
    font-size: 16px;
  }
  
  .room-status {
    font-size: 11px;
    padding: 4px 10px;
  }
}
    </style>
  </head>

  <body>
    <!-- Mobile Hamburger Button -->
    <button class="hamburger-btn" onclick="toggleSidebar()">
      <span></span>
      <span></span>
      <span></span>
    </button>

    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" onclick="closeSidebar()"></div>

    <div class="sidebar" id="sidebar">
      <h2>Admin AKITA</h2>
      <a href="#" onclick="showSection('dashboard')" class="nav-link active"
        >üìä Dashboard</a
      >
      <a href="#" onclick="showSection('kelola')" class="nav-link"
        >üìã Kelola Agenda</a
      >
      <a href="#" onclick="showSection('tambah')" class="nav-link"
        >‚ûï Tambah Agenda</a
      >
      <a href="#" onclick="showSection('capaian')" class="nav-link"
        >‚úÖ Capaian Agenda</a
      >
      <a href="#" onclick="showSection('admin')" class="nav-link"
        >üë§ Kelola Admin</a
      >
      <a href="#" onclick="showSection('ketersediaan')" class="nav-link"
  >üè¢ Ketersediaan Ruangan</a
>
    </div>

    <div class="main-content">
      <div class="toast-container" id="toast-container"></div>

<div class="header">
  <h1>Agenda Kita</h1>
  <p>Sistem Manajemen Agenda Kantor</p>
  <p id="adminInfo" style="font-size: 13px; opacity: 0.9; margin-top: 8px;"></p>
</div>

      <!-- Dashboard Section -->
      <div id="dashboard" class="content-section active">
        <!-- Stats Cards -->
        <div class="stats-grid">
          <div class="stat-card">
            <h3 id="total-agenda">0</h3>
            <p>Total Agenda</p>
          </div>
          <div class="stat-card">
            <h3 id="agenda-hari-ini">0</h3>
            <p>Agenda Hari Ini</p>
          </div>
          <div class="stat-card">
            <h3 id="agenda-minggu">0</h3>
            <p>Agenda Minggu Ini</p>
          </div>
        </div>

        <!-- Charts Grid -->
        <div class="dashboard-grid">
          <!-- Busy Days Analysis -->
          <div class="card">
            <h2>Analisa Hari Tersibuk</h2>
            <div class="chart-filters">
              <select id="monthFilter" onchange="updateChart()">
                <option value="all">Semua Bulan</option>
                <option value="1">Januari</option>
                <option value="2">Februari</option>
                <option value="3">Maret</option>
                <option value="4">April</option>
                <option value="5">Mei</option>
                <option value="6">Juni</option>
                <option value="7">Juli</option>
                <option value="8">Agustus</option>
                <option value="9">September</option>
                <option value="10">Oktober</option>
                <option value="11">November</option>
                <option value="12">Desember</option>
              </select>
              <select id="chartType" onchange="updateChart()">
                <option value="bar">Bar Chart</option>
                <option value="line">Line Chart</option>
                <option value="doughnut">Doughnut Chart</option>
              </select>
            </div>
            <div class="chart-container">
              <canvas id="busyDaysChart"></canvas>
            </div>
          </div>
        </div>

        <!-- PIC Analysis -->
        <div class="card">
          <h2>Analisa Beban Kerja PIC</h2>
          <div class="chart-filters">
            <select id="picPeriod" onchange="updatePICAnalysis()">
              <option value="month">Bulan Ini</option>
              <option value="quarter">Quarter Ini</option>
              <option value="year">Tahun Ini</option>
            </select>
          </div>
          <div class="pic-analysis-grid">
            <div class="chart-container">
              <canvas id="picWorkloadChart"></canvas>
            </div>
            <div class="chart-container">
              <canvas id="picEfficiencyChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Location Analysis -->
        <div class="card">
          <h2>Analisa Utilitas Tempat</h2>
          <div class="chart-filters">
            <button class="tab active" onclick="switchLocationView('usage')">
              Penggunaan Ruang
            </button>
            <button class="tab" onclick="switchLocationView('efficiency')">
              Efisiensi Ruang
            </button>
            <button class="tab" onclick="switchLocationView('peak')">
              Peak Hours
            </button>
          </div>
          <div class="chart-container">
            <canvas id="locationChart"></canvas>
          </div>
        </div>

        <!-- Capaian Dashboard Analysis -->
<div class="card">
  <h2>Dashboard Capaian Agenda</h2>
  
  <div class="chart-filters">
    <select id="capaianPeriod" onchange="updateCapaianDashboard()">
      <option value="month">Bulan Ini</option>
      <option value="quarter">Triwulan Ini</option>
      <option value="semester">Semester Ini</option>
      <option value="year">Tahun Ini</option>
    </select>
    <button class="btn btn-info" onclick="printCapaianDashboard()">
      üìÑ Cetak Laporan
    </button>
  </div>

  <!-- Statistics Cards -->
  <div class="metric-comparison" id="capaianMetrics">
    <div class="metric-item">
      <div class="metric-value" id="totalCapaian">0</div>
      <div class="metric-label">Total Agenda</div>
    </div>
    <div class="metric-item">
      <div class="metric-value" id="selesaiCapaian">0</div>
      <div class="metric-label">Selesai</div>
    </div>
    <div class="metric-item">
      <div class="metric-value" id="ditundaCapaian">0</div>
      <div class="metric-label">Ditunda</div>
    </div>
    <div class="metric-item">
      <div class="metric-value" id="batalCapaian">0</div>
      <div class="metric-label">Batal</div>
    </div>
    <div class="metric-item">
      <div class="metric-value" id="belumCapaian">0</div>
      <div class="metric-label">Belum Selesai</div>
    </div>
    <div class="metric-item">
      <div class="metric-value" id="percentageCapaian">0%</div>
      <div class="metric-label">Persentase Selesai</div>
    </div>
  </div>

  <!-- Charts -->
  <div class="pic-analysis-grid">
    <div class="chart-container">
      <canvas id="capaianStatusChart"></canvas>
    </div>
    <div class="chart-container">
      <canvas id="capaianTrendChart"></canvas>
    </div>
  </div>

  <!-- Insights -->
  <div class="insight-card" id="capaianInsight">
    <div class="insight-title">üìä Insight Capaian</div>
    <div class="insight-text" id="insightText">Memuat data...</div>
  </div>
</div>
      </div>

      <!-- Kelola Agenda Section -->
      <div id="kelola" class="content-section">
        <div class="card">
          <h2>Kelola Agenda</h2>

          <div class="filter-tabs">
            <div class="tab active" onclick="filterAgenda('all')">Semua</div>
            <div class="tab" onclick="filterAgenda('today')">Hari Ini</div>
            <div class="tab" onclick="filterAgenda('week')">Mendatang</div>
          </div>

          <div class="search-container">
            <span class="search-icon">üîç</span>
            <input
              type="text"
              class="search-box"
              id="searchInput"
              placeholder="Cari agenda, PIC, atau tempat..."
            />
            <button
              class="search-clear"
              id="searchClear"
              onclick="clearSearch()"
            >
              √ó
            </button>
            <div class="search-stats" id="searchStats"></div>
          </div>

          <div class="table-container">
            <table id="agenda-table">
              <thead>
                <tr>
                  <th>Tanggal</th>
                  <th>Jam</th>
                  <th>Agenda</th>
                  <th>PIC</th>
                  <th>Tempat</th>
                  <th>Aksi</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div id="editForm" class="edit-form hidden">
            <h3>Edit Agenda</h3>
            <form onsubmit="submitEdit(event)">
              <input type="hidden" id="edit-id" />
              <div class="form-row">
                <div class="form-group">
                  <label>Tanggal</label>
                  <input type="date" id="edit-tanggal" required />
                </div>
                <div class="form-group">
                  <label>Jam</label>
                  <input type="text" id="edit-jam" placeholder="Jam" required />
                </div>
              </div>
              <div class="form-group">
                <label>Agenda</label>
                <input
                  type="text"
                  id="edit-agenda"
                  placeholder="Agenda"
                  required
                />
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>PIC</label>
                  <input type="text" id="edit-pic" placeholder="PIC" />
                </div>
                <div class="form-group">
                  <label>Tempat</label>
                  <input type="text" id="edit-tempat" placeholder="Tempat" />
                </div>
              </div>
              <button type="submit" class="btn btn-primary">Simpan</button>
              <button
                type="button"
                class="btn btn-secondary"
                onclick="cancelEdit()"
              >
                Batal
              </button>
            </form>
          </div>
        </div>
      </div>

      <!-- Tambah Agenda Section -->
      <div id="tambah" class="content-section">
        <div class="card">
          <h2>Tambah Agenda</h2>
          <form onsubmit="submitTambah(event)">
            <div class="form-row">
              <div class="form-group">
                <label>Tanggal</label>
                <input type="date" id="tanggal" required />
              </div>
              <div class="form-group">
                <label>Jam</label>
                <input
                  type="text"
                  id="jam"
                  placeholder="08.00 - 10.00"
                  required
                />
              </div>
            </div>
            <div class="form-group">
              <label>Agenda</label>
              <input
                type="text"
                id="agenda"
                placeholder="Masukkan agenda"
                required
              />
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>PIC</label>
                <input type="text" id="pic" placeholder="Person in Charge" />
              </div>
              <div class="form-group">
                <label>Tempat</label>
                <input type="text" id="tempat" placeholder="Lokasi kegiatan" />
              </div>
            </div>
            <button type="submit" class="btn btn-primary">Tambah Agenda</button>
          </form>
        </div>
      </div>

      <div id="capaian" class="content-section">
        <div class="card">
          <h2>Capaian Agenda</h2>

          <div class="filter-tabs">
            <div class="tab active" onclick="filterCapaian('all')">Semua</div>
            <div class="tab" onclick="filterCapaian('selesai')">Selesai</div>
            <div class="tab" onclick="filterCapaian('ditunda')">Ditunda</div>
            <div class="tab" onclick="filterCapaian('batal')">Batal</div>
            <div class="tab" onclick="filterCapaian('belum_selesai')">
              Belum Selesai
            </div>
          </div>

          <div class="search-container">
            <span class="search-icon">üîç</span>
            <input
              type="text"
              class="search-box"
              id="searchCapaianInput"
              placeholder="Cari agenda untuk update capaian..."
            />
            <button
              class="search-clear"
              id="searchCapaianClear"
              onclick="clearCapaianSearch()"
            >
              √ó
            </button>
            <div class="search-stats" id="searchCapaianStats"></div>
          </div>

          <div class="table-container">
            <table id="capaian-table">
              <thead>
                <tr>
                  <th>Tanggal</th>
                  <th>Jam</th>
                  <th>Agenda</th>
                  <th>PIC</th>
                  <th>Status</th>
                  <th>Aksi</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <!-- Form Update Capaian -->
          <div id="capaianForm" class="edit-form hidden">
            <h3>Update Capaian Agenda</h3>
            <form onsubmit="submitCapaian(event)">
              <input type="hidden" id="capaian-id" />

              <!-- Info Agenda -->
              <div class="form-group">
                <label>Agenda</label>
                <input
                  type="text"
                  id="capaian-agenda"
                  readonly
                  style="background: #f5f5f5"
                />
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label>Tanggal</label>
                  <input
                    type="text"
                    id="capaian-tanggal"
                    readonly
                    style="background: #f5f5f5"
                  />
                </div>
                <div class="form-group">
                  <label>PIC</label>
                  <input
                    type="text"
                    id="capaian-pic"
                    readonly
                    style="background: #f5f5f5"
                  />
                </div>
              </div>

              <!-- Status -->
              <div class="form-group">
                <label>Status Capaian *</label>
                <select id="capaian-status" required>
                  <option value="belum_selesai">Belum Selesai</option>
                  <option value="selesai">Selesai</option>
                  <option value="ditunda">Ditunda</option>
                  <option value="batal">Batal</option>
                </select>
              </div>

              <!-- Upload Foto -->
              <div class="form-group">
                <label>Foto Dokumentasi (opsional)</label>
                <input type="file" id="capaian-foto" accept="image/*" />
                <small style="color: #666; font-size: 12px"
                  >Format: JPG, PNG, maksimal 5MB</small
                >
                <div id="current-foto" class="current-foto hidden">
                  <p>Foto saat ini:</p>
                  <img
                    id="current-foto-preview"
                    style="
                      max-width: 200px;
                      max-height: 150px;
                      border-radius: 8px;
                    "
                  />
                </div>
              </div>

              <!-- Keterangan -->
              <div class="form-group">
                <label>Keterangan (opsional)</label>
                <textarea
                  id="capaian-keterangan"
                  placeholder="Tambahkan keterangan tentang capaian agenda..."
                  rows="4"
                ></textarea>
              </div>

              <button type="submit" class="btn btn-primary">
                Simpan Capaian
              </button>
              <button
                type="button"
                class="btn btn-secondary"
                onclick="cancelCapaian()"
              >
                Batal
              </button>
            </form>
          </div>
        </div>
      </div>
      <!-- Kelola Admin Section -->
      <div id="admin" class="content-section">
        <div class="card">
          <h2>Kelola Admin</h2>
         
          <div class="search-container">
            <span class="search-icon">üîç</span>
            <input
              type="text"
              class="search-box"
              id="searchAdminInput"
              placeholder="Cari admin berdasarkan nama atau email..."
            />
            <button
              class="search-clear"
              id="searchAdminClear"
              onclick="clearAdminSearch()"
            >
              √ó
            </button>
            <div class="search-stats" id="searchAdminStats"></div>
          </div>

          <div style="margin-bottom: 20px">
            <button onclick="showTambahAdmin()" class="btn btn-primary">
              + Tambah Admin Baru
            </button>
          </div>

          <div class="table-container">
            <table id="admin-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Nama</th>
                  <th>Email</th>
                  <th>Dibuat</th>
                  <th>Aksi</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <!-- Form Tambah Admin -->
          <div id="tambahAdminForm" class="edit-form hidden">
            <h3>Tambah Admin Baru</h3>
            <form onsubmit="submitTambahAdmin(event)">
              <div class="form-group">
                <label>Nama Admin *</label>
                <input
                  type="text"
                  id="admin-nama"
                  placeholder="Nama lengkap admin"
                  required
                />
              </div>
              <div class="form-group">
                <label>Email *</label>
                <input
                  type="email"
                  id="admin-email"
                  placeholder="email@example.com"
                  required
                />
              </div>
              <div class="form-group">
                <label>Password *</label>
                <input
                  type="password"
                  id="admin-password"
                  placeholder="Password minimal 6 karakter"
                  required
                  minlength="6"
                />
              </div>
              <button type="submit" class="btn btn-primary">
                Tambah Admin
              </button>
              <button
                type="button"
                class="btn btn-secondary"
                onclick="cancelTambahAdmin()"
              >
                Batal
              </button>
            </form>
          </div>

          <!-- Form Edit Admin -->
          <div id="editAdminForm" class="edit-form hidden">
            <h3>Edit Admin</h3>
            <form onsubmit="submitEditAdmin(event)">
              <input type="hidden" id="edit-admin-id" />
              <div class="form-group">
                <label>Nama Admin *</label>
                <input type="text" id="edit-admin-nama" required />
              </div>
              <div class="form-group">
                <label>Email *</label>
                <input type="email" id="edit-admin-email" required />
              </div>
              <div class="form-group">
                <label>Password Baru (kosongkan jika tidak diubah)</label>
                <input
                  type="password"
                  id="edit-admin-password"
                  placeholder="Kosongkan jika tidak ingin mengubah password"
                />
              </div>
              <button type="submit" class="btn btn-primary">
                Simpan Perubahan
              </button>
              <button
                type="button"
                class="btn btn-secondary"
                onclick="cancelEditAdmin()"
              >
                Batal
              </button>
            </form>
          </div>
        </div>
      </div>
      <!-- Ketersediaan Ruangan Section -->
<div id="ketersediaan" class="content-section">
  <div class="card">
    <h2>Ketersediaan Ruangan</h2>
    
    <!-- Date Filter -->
    <div class="chart-filters" style="margin-bottom: 20px;">
      <select id="ketersediaanDate" onchange="updateKetersediaan()">
        <option value="today">Hari Ini</option>
        <option value="tomorrow">Besok</option>
        <option value="custom">Pilih Tanggal</option>
      </select>
      <input type="date" id="customDate" style="display:none;" onchange="updateKetersediaan()">
      <button class="btn btn-info" onclick="refreshKetersediaan()">üîÑ Refresh</button>
    </div>

    <!-- Room Availability Grid -->
    <div id="roomAvailabilityGrid">
      <div style="text-align: center; padding: 40px; color: #666;">
        <div style="font-size: 48px; margin-bottom: 10px;">üìÖ</div>
        <div>Memuat data ketersediaan ruangan...</div>
      </div>
    </div>
  </div>

  <!-- Timeline View -->
  <div class="card" style="margin-top: 20px;">
    <h2>Timeline Penggunaan Ruangan</h2>
    <div class="chart-container" style="height: 400px;">
      <canvas id="roomTimelineChart"></canvas>
    </div>
  </div>

  <!-- Legend -->
  <div class="card" style="margin-top: 20px;">
    <div style="display: flex; gap: 20px; justify-content: center; align-items: center;">
      <div style="display: flex; align-items: center; gap: 8px;">
        <div style="width: 20px; height: 20px; background: #28a745; border-radius: 4px;"></div>
        <span>Tersedia</span>
      </div>
      <div style="display: flex; align-items: center; gap: 8px;">
        <div style="width: 20px; height: 20px; background: #dc3545; border-radius: 4px;"></div>
        <span>Terpakai</span>
      </div>
      <div style="display: flex; align-items: center; gap: 8px;">
        <div style="width: 20px; height: 20px; background: #ffc107; border-radius: 4px;"></div>
        <span>Segera Dimulai</span>
      </div>
    </div>
  </div>
</div>
    </div>
    <script>

      // ===== SESSION PROTECTION =====
  function checkAuth() {
    const isLoggedIn = localStorage.getItem("loggedIn");
    const expireTime = localStorage.getItem("expireTime");
    const loginTime = localStorage.getItem("loginTime");
    
    if (isLoggedIn !== "true" || !expireTime || !loginTime) {
      console.log("Not logged in, redirecting to login page");
      window.location.href = "login.html";
      return false;
    }
    
    if (Date.now() > parseInt(expireTime)) {
      console.log("Session expired, clearing data and redirecting");
      clearLoginData();
      alert("Sesi login Anda telah habis. Silakan login kembali.");
      window.location.href = "login.html";
      return false;
    }
    
    return true;
  }

  // Fungsi helper untuk mendapatkan nama admin yang login
function getLoggedInAdminName() {
  return localStorage.getItem("adminNama") || localStorage.getItem("adminEmail") || "Unknown Admin";
}
  // Tambahkan setelah fungsi checkAuth()
function updateAdminInfo() {
  const adminEmail = localStorage.getItem("adminEmail");
  const adminNama = localStorage.getItem("adminNama");
  const adminInfoElement = document.getElementById("adminInfo");
  
  if (adminInfoElement && adminEmail) {
    const displayName = adminNama || adminEmail;
    
    adminInfoElement.innerHTML = `
      Login sebagai: <strong>${displayName}</strong> 
      <button onclick="logout()" style="margin-left: 10px; padding: 4px 12px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; color: white; cursor: pointer; font-size: 12px; transition: all 0.3s ease;">
        Logout
      </button>
    `;
    
    // Tambahkan hover effect
    const logoutBtn = adminInfoElement.querySelector('button');
    if (logoutBtn) {
      logoutBtn.addEventListener('mouseenter', function() {
        this.style.background = 'rgba(255,255,255,0.3)';
      });
      logoutBtn.addEventListener('mouseleave', function() {
        this.style.background = 'rgba(255,255,255,0.2)';
      });
    }
  }
}

// Fungsi logout
function logout() {
  if (confirm("Yakin ingin logout?")) {
    clearLoginData();
    window.location.href = "login.html";
  }
}

  function clearLoginData() {
    localStorage.removeItem("loggedIn");
    localStorage.removeItem("expireTime");
    localStorage.removeItem("loginTime");
    localStorage.removeItem("adminEmail");
    localStorage.removeItem("adminId");
    localStorage.removeItem("adminNama");
  }

  // Check authentication immediately when script loads
  if (!checkAuth()) {
    throw new Error("Unauthorized access");
  }
      // ===== GLOBAL VARIABLES =====
      let busyDaysChart = null;
      let picWorkloadChart = null;
      let picEfficiencyChart = null;
      let locationChart = null;
      let capaianStatusChart = null;
let capaianTrendChart = null;
let currentCapaianPeriod = 'month';
      let chartData = [];
      let searchQuery = "";
      let allAgendaData = [];
      let currentFilter = "all";

      // ===== API ENDPOINTS =====
      // ===== API ENDPOINTS =====
      const API_ENDPOINTS = {
        GET_AGENDA: "/api/get-agenda",
        ADD_AGENDA: "/api/add-agenda",
        EDIT_AGENDA: "/api/edit-agenda",
        DELETE_AGENDA: "/api/delete-agenda",
        GET_CAPAIAN: "/api/get-agenda", // Menggunakan endpoint yang sama
        UPDATE_CAPAIAN: "/api/edit-agenda", // Menggunakan endpoint yang sama
      };

      // ===== UTILITY FUNCTIONS =====
      function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func.apply(this, args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      }

      function formatDate(dateString) {
        const date = new Date(dateString);
        const options = {
          year: "numeric",
          month: "long",
          day: "numeric",
        };
        return date.toLocaleDateString("id-ID", options);
      }

      function getTodayDate() {
        const today = new Date();
        return today.toISOString().split("T")[0];
      }

      function getWeekFromNow() {
        const weekFromNow = new Date();
        weekFromNow.setDate(weekFromNow.getDate() + 7);
        return weekFromNow.toISOString().split("T")[0];
      }
      function getDateRange(period) {
  const today = new Date();
  const year = today.getFullYear();
  const month = today.getMonth();
  const day = today.getDate();
  
  let startDate, endDate;
  
  switch(period) {
    case 'month':
      startDate = new Date(year, month, 1);
      endDate = new Date(year, month + 1, 0);
      break;
      
    case 'quarter':
      const quarter = Math.floor(month / 3);
      startDate = new Date(year, quarter * 3, 1);
      endDate = new Date(year, quarter * 3 + 3, 0);
      break;
      
    case 'semester':
      const semester = month < 6 ? 0 : 1;
      startDate = new Date(year, semester * 6, 1);
      endDate = new Date(year, semester * 6 + 6, 0);
      break;
      
    case 'year':
      startDate = new Date(year, 0, 1);
      endDate = new Date(year, 11, 31);
      break;
      
    default:
      startDate = new Date(year, month, 1);
      endDate = new Date(year, month + 1, 0);
  }
  
  return {
    start: startDate.toISOString().split('T')[0],
    end: endDate.toISOString().split('T')[0]
  };
}

function getPeriodName(period) {
  const today = new Date();
  const year = today.getFullYear();
  const month = today.getMonth();
  
  const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
                      'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
  
  switch(period) {
    case 'month':
      return `${monthNames[month]} ${year}`;
      
    case 'quarter':
      const quarter = Math.floor(month / 3) + 1;
      return `Triwulan ${quarter} ${year}`;
      
    case 'semester':
      const semester = month < 6 ? 1 : 2;
      return `Semester ${semester} ${year}`;
      
    case 'year':
      return `Tahun ${year}`;
      
    default:
      return '';
  }
}

      function escapeRegExp(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
      }

      // ===== TOAST NOTIFICATION SYSTEM =====
      function showToast(message, type = "success") {
        const container = document.getElementById("toast-container");
        const toast = document.createElement("div");
        toast.className = `toast ${type}`;

        const icons = {
          success: "‚úÖ",
          error: "‚ùå",
          warning: "‚ö†Ô∏è",
          info: "‚ÑπÔ∏è",
        };

        toast.innerHTML = `
        <div class="toast-content">
          <span class="toast-icon">${icons[type]}</span>
          <span class="toast-message">${message}</span>
          <button class="toast-close" onclick="closeToast(this)">√ó</button>
        </div>
      `;

        container.appendChild(toast);
        setTimeout(() => toast.classList.add("show"), 100);
        setTimeout(() => closeToast(toast), 4000);
      }

      function closeToast(element) {
        const toast = element.closest ? element.closest(".toast") : element;
        toast.classList.remove("show");
        setTimeout(() => toast.remove(), 300);
      }

      // ===== LOADING STATE HELPERS =====
      function setButtonLoading(
        button,
        isLoading,
        loadingText = "Memproses..."
      ) {
        if (isLoading) {
          button.originalText = button.textContent;
          button.textContent = loadingText;
          button.classList.add("loading");
          button.disabled = true;
        } else {
          button.textContent = button.originalText;
          button.classList.remove("loading");
          button.disabled = false;
        }
      }

      function setTableLoading(tableId, isLoading) {
        const table = document.getElementById(tableId);
        if (isLoading) {
          table.classList.add("table-loading");
        } else {
          table.classList.remove("table-loading");
        }
      }

      // ===== SEARCH FUNCTIONALITY =====
      function initSearch() {
        const searchInput = document.getElementById("searchInput");
        const searchClear = document.getElementById("searchClear");

        if (!searchInput || !searchClear) return;

        searchInput.addEventListener("input", handleSearchInput);
        searchClear.style.display = "none";
      }

      const handleSearchInput = debounce(function (event) {
        searchQuery = event.target.value.toLowerCase().trim();
        const searchClear = document.getElementById("searchClear");

        if (searchQuery.length > 0) {
          searchClear.style.display = "block";
        } else {
          searchClear.style.display = "none";
        }

        displayFilteredAgenda();
      }, 300);

      function clearSearch() {
        const searchInput = document.getElementById("searchInput");
        const searchClear = document.getElementById("searchClear");
        const searchStats = document.getElementById("searchStats");

        if (searchInput) searchInput.value = "";
        if (searchClear) searchClear.style.display = "none";
        if (searchStats) searchStats.textContent = "";

        searchQuery = "";
        displayFilteredAgenda();
      }

      function searchAgenda(data, query) {
        if (!query || query.length === 0) return data;

        return data.filter((item) => {
          const searchableFields = [
            item.agenda || "",
            item.pic || "",
            item.tempat || "",
            item.tanggal || "",
            item.jam || "",
          ];

          const searchableText = searchableFields.join(" ").toLowerCase();
          const queryWords = query.split(" ").filter((word) => word.length > 0);

          return queryWords.every((word) => searchableText.includes(word));
        });
      }

      function highlightText(text, query) {
        if (!query || !text || query.length === 0) return text;

        const queryWords = query.split(" ").filter((word) => word.length > 0);
        let highlightedText = text;

        queryWords.forEach((word) => {
          const regex = new RegExp(`(${escapeRegExp(word)})`, "gi");
          highlightedText = highlightedText.replace(
            regex,
            '<span class="highlight">$1</span>'
          );
        });

        return highlightedText;
      }

      // ===== FILTER FUNCTIONALITY =====
      function filterAgenda(type) {
        currentFilter = type;

        document.querySelectorAll(".filter-tabs .tab").forEach((tab) => {
          tab.classList.remove("active");
        });

        event.target.classList.add("active");
        displayFilteredAgenda();
      }

      function filterAgendaData(data) {
        const today = getTodayDate();
        const weekFromNow = getWeekFromNow();

        switch (currentFilter) {
          case "today":
            return data.filter((item) => item.tanggal === today);
          case "week":
            return data.filter(
              (item) => item.tanggal >= today && item.tanggal <= weekFromNow
            );
          default:
            return data;
        }
      }
      // ===== SORTING FUNCTION =====
      function sortAgendaByDateTime(data) {
        return data.sort((a, b) => {
          // Pertama sort berdasarkan tanggal
          const dateA = new Date(a.tanggal);
          const dateB = new Date(b.tanggal);

          if (dateA.getTime() !== dateB.getTime()) {
            return dateB.getTime() - dateA.getTime(); // Descending by date
          }

          // Jika tanggal sama, sort berdasarkan jam
          const timeA = parseTime(a.jam);
          const timeB = parseTime(b.jam);

          return timeB - timeA; // Descending by time
        });
      }

      function parseTime(timeString) {
        if (!timeString) return 0;

        // Extract first time from formats like "08:00", "08.00", "08:00 - 10:00", etc.
        const timeMatch = timeString.match(/(\d{1,2})[:.:](\d{2})/);
        if (timeMatch) {
          const hours = parseInt(timeMatch[1]);
          const minutes = parseInt(timeMatch[2]);
          return hours * 60 + minutes; // Convert to minutes for comparison
        }

        return 0;
      }

      // ===== DISPLAY FUNCTIONS =====
      function displayFilteredAgenda() {
        const tbody = document.querySelector("#agenda-table tbody");
        const searchStats = document.getElementById("searchStats");

        if (!tbody) return;

        let filteredData = filterAgendaData(allAgendaData);

        if (searchQuery && searchQuery.length > 0) {
          filteredData = searchAgenda(filteredData, searchQuery);
        }

        // Sort data by date and time (descending)
        filteredData = sortAgendaByDateTime(filteredData);

        tbody.innerHTML = "";

        if (filteredData.length === 0) {
          const noResultsMessage = searchQuery
            ? `Tidak ditemukan agenda yang sesuai dengan "${searchQuery}"`
            : "Tidak ada agenda untuk filter yang dipilih";

          tbody.innerHTML = `
          <tr>
            <td colspan="6" class="no-results">
              <div class="no-results-icon">üòî</div>
              <div>${noResultsMessage}</div>
            </td>
          </tr>
        `;

          updateSearchStats(searchStats, 0, allAgendaData.length);
          return;
        }

        filteredData.forEach((row) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
          <td title="${formatDate(row.tanggal)}">${highlightText(
            formatDate(row.tanggal),
            searchQuery
          )}</td>
          <td title="${row.jam}">${highlightText(row.jam, searchQuery)}</td>
          <td title="${row.agenda}">${highlightText(
            row.agenda,
            searchQuery
          )}</td>
          <td title="${row.pic || "Tidak ada PIC"}">${highlightText(
            row.pic || "Tidak ada PIC",
            searchQuery
          )}</td>
          <td title="${row.tempat || "Tidak ada lokasi"}">${highlightText(
            row.tempat || "Tidak ada lokasi",
            searchQuery
          )}</td>
          <td>
            <button onclick='editAgenda(${JSON.stringify(row).replace(
              /'/g,
              "&#39;"
            )})' class="btn btn-warning">Edit</button>
            <button onclick='deleteAgenda(${
              row.id
            })' class="btn btn-danger">Hapus</button>
          </td>
        `;
          tbody.appendChild(tr);
        });

        updateSearchStats(
          searchStats,
          filteredData.length,
          allAgendaData.length
        );
      }

      function updateSearchStats(searchStats, totalResults, totalData) {
        if (!searchStats) return;

        if (searchQuery && searchQuery.length > 0) {
          searchStats.textContent = `Menampilkan ${totalResults} dari ${totalData} agenda`;
        } else {
          searchStats.textContent = "";
        }
      }

      // ===== API FUNCTIONS =====
      async function loadAgenda() {
        setTableLoading("agenda-table", true);

        try {
          const response = await fetch(API_ENDPOINTS.GET_AGENDA);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          allAgendaData = data || [];
          displayFilteredAgenda();
        } catch (error) {
          console.error("Error loading agenda:", error);
          showToast("Gagal memuat data agenda!", "error");
          allAgendaData = [];
          displayFilteredAgenda();
        } finally {
          setTableLoading("agenda-table", false);
        }
      }

      async function loadDashboardStats() {
        try {
          const response = await fetch(API_ENDPOINTS.GET_AGENDA);
          const data = await response.json();

          const today = getTodayDate();
          const weekFromNow = getWeekFromNow();

          const todayAgenda = data.filter((item) => item.tanggal === today);
          const weekAgenda = data.filter(
            (item) => item.tanggal >= today && item.tanggal <= weekFromNow
          );

          document.getElementById("total-agenda").textContent = data.length;
          document.getElementById("agenda-hari-ini").textContent =
            todayAgenda.length;
          document.getElementById("agenda-minggu").textContent =
            weekAgenda.length;

          chartData = data;
          createBusyDaysChart(data);
          createPICAnalysis(data);
          createLocationChart(data);
          updateCapaianDashboard();
        } catch (error) {
          console.error("Error loading dashboard stats:", error);
          showToast("Gagal memuat statistik!", "error");
        }
      }

      async function submitTambah(e) {
        e.preventDefault();
        const submitBtn = e.target.querySelector('button[type="submit"]');
        setButtonLoading(submitBtn, true, "Menambahkan...");

        const formData = {
          tanggal: document.getElementById("tanggal").value,
          jam: document.getElementById("jam").value,
          agenda: document.getElementById("agenda").value,
          pic: document.getElementById("pic").value,
          tempat: document.getElementById("tempat").value,
            updated_by: getLoggedInAdminName()
        };

        try {
          const response = await fetch(API_ENDPOINTS.ADD_AGENDA, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(formData),
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          showToast("Agenda berhasil ditambahkan!", "success");
          e.target.reset();
          loadDashboardStats();
        } catch (error) {
          console.error("Error adding agenda:", error);
          showToast("Gagal menambahkan agenda!", "error");
        } finally {
          setButtonLoading(submitBtn, false);
        }
      }

      async function submitEdit(e) {
        e.preventDefault();
        const submitBtn = e.target.querySelector('button[type="submit"]');
        setButtonLoading(submitBtn, true, "Menyimpan...");

        const id = document.getElementById("edit-id").value;
        const data = {
          id: parseInt(id),
          tanggal: document.getElementById("edit-tanggal").value,
          jam: document.getElementById("edit-jam").value,
          agenda: document.getElementById("edit-agenda").value,
          pic: document.getElementById("edit-pic").value,
          tempat: document.getElementById("edit-tempat").value,
            updated_by: getLoggedInAdminName() 
        };

        try {
          const response = await fetch(API_ENDPOINTS.EDIT_AGENDA, {
            method: "PATCH",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(data),
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          showToast("Agenda berhasil diupdate!", "success");
          cancelEdit();
          loadAgenda();
          loadDashboardStats();
          // Scroll ke atas setelah berhasil simpan
          setTimeout(() => {
            window.scrollTo({
              top: 0,
              behavior: "smooth",
            });
          }, 200);
        } catch (error) {
          console.error("Error updating agenda:", error);
          showToast("Gagal mengupdate agenda!", "error");
        } finally {
          setButtonLoading(submitBtn, false);
        }
      }

      function editAgenda(data) {
        showSection("kelola");
        document.getElementById("editForm").classList.remove("hidden");
        document.getElementById("edit-id").value = data.id;
        document.getElementById("edit-tanggal").value = data.tanggal;
        document.getElementById("edit-jam").value = data.jam;
        document.getElementById("edit-agenda").value = data.agenda;
        document.getElementById("edit-pic").value = data.pic || "";
        document.getElementById("edit-tempat").value = data.tempat || "";

        // Scroll ke form edit
        setTimeout(() => {
          document.getElementById("editForm").scrollIntoView({
            behavior: "smooth",
            block: "start",
          });
        }, 45);
      }

      function cancelEdit() {
        document.getElementById("editForm").classList.add("hidden");
        setTimeout(() => {
          window.scrollTo({
            top: 0,
            behavior: "smooth",
          });
        }, 100);
      }

      async function deleteAgenda(id) {
        if (!confirm("Yakin ingin menghapus agenda ini?")) return;

        const deleteBtn = event.target;
        setButtonLoading(deleteBtn, true, "Menghapus...");

        try {
          const response = await fetch(API_ENDPOINTS.DELETE_AGENDA, {
            method: "DELETE",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ id: parseInt(id) }),
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          showToast("Agenda berhasil dihapus!", "success");
          loadAgenda();
          loadDashboardStats();
        } catch (error) {
          console.error("Error deleting agenda:", error);
          showToast("Gagal menghapus agenda!", "error");
        } finally {
          setButtonLoading(deleteBtn, false);
        }
      }

      // ===== CHART FUNCTIONS =====
      function analyzeBusyDays(data) {
        const dayNames = [
          "Minggu",
          "Senin",
          "Selasa",
          "Rabu",
          "Kamis",
          "Jumat",
          "Sabtu",
        ];
        const dayCounts = [0, 0, 0, 0, 0, 0, 0];
        const monthFilter = document.getElementById("monthFilter").value;

        data.forEach((item) => {
          const date = new Date(item.tanggal);
          const month = date.getMonth() + 1;

          if (monthFilter !== "all" && month !== parseInt(monthFilter)) {
            return;
          }

          const dayIndex = date.getDay();
          dayCounts[dayIndex]++;
        });

        return {
          labels: dayNames,
          data: dayCounts,
        };
      }

      function getMonthName() {
        const monthFilter = document.getElementById("monthFilter").value;
        if (monthFilter === "all") return "(Semua Bulan)";

        const months = [
          "",
          "Januari",
          "Februari",
          "Maret",
          "April",
          "Mei",
          "Juni",
          "Juli",
          "Agustus",
          "September",
          "Oktober",
          "November",
          "Desember",
        ];

        return `(${months[parseInt(monthFilter)]})`;
      }

      function createBusyDaysChart(data) {
        const ctx = document.getElementById("busyDaysChart").getContext("2d");
        const chartType = document.getElementById("chartType").value;

        if (busyDaysChart) {
          busyDaysChart.destroy();
        }

        const analyzedData = analyzeBusyDays(data);
        const colors = [
          "#FF6384",
          "#36A2EB",
          "#FFCE56",
          "#4BC0C0",
          "#9966FF",
          "#FF9F40",
          "#FF6384",
        ];

        const config = {
          type: chartType,
          data: {
            labels: analyzedData.labels,
            datasets: [
              {
                label: "Jumlah Agenda",
                data: analyzedData.data,
                backgroundColor:
                  chartType === "doughnut"
                    ? colors
                    : "rgba(102, 126, 234, 0.8)",
                borderColor:
                  chartType === "doughnut" ? colors : "rgba(102, 126, 234, 1)",
                borderWidth: 2,
                tension: 0.4,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: chartType === "doughnut",
                position: "bottom",
              },
              title: {
                display: true,
                text: `Distribusi Agenda per Hari ${getMonthName()}`,
              },
            },
            scales:
              chartType !== "doughnut"
                ? {
                    y: {
                      beginAtZero: true,
                      ticks: {
                        stepSize: 1,
                      },
                    },
                  }
                : {},
          },
        };

        busyDaysChart = new Chart(ctx, config);
      }

      function analyzePICWorkload(data) {
        const picMap = {};

        data.forEach((item) => {
          const pic = item.pic || "Tidak Ada PIC";
          picMap[pic] = (picMap[pic] || 0) + 1;
        });

        const names = Object.keys(picMap);
        const counts = Object.values(picMap);
        const total = counts.reduce((a, b) => a + b, 0);
        const efficiency = counts.map((count) =>
          Math.round((count / total) * 100)
        );

        return { names, counts, efficiency };
      }

      function createPICAnalysis(data) {
        const picData = analyzePICWorkload(data);

        // Workload Chart
        const ctx1 = document
          .getElementById("picWorkloadChart")
          .getContext("2d");
        if (picWorkloadChart) picWorkloadChart.destroy();

        picWorkloadChart = new Chart(ctx1, {
          type: "bar",
          data: {
            labels: picData.names,
            datasets: [
              {
                label: "Jumlah Agenda",
                data: picData.counts,
                backgroundColor: "#4ecdc4",
                borderColor: "#26d0ce",
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              title: {
                display: true,
                text: "Beban Kerja per PIC",
              },
            },
          },
        });

        // Efficiency Chart
        const ctx2 = document
          .getElementById("picEfficiencyChart")
          .getContext("2d");
        if (picEfficiencyChart) picEfficiencyChart.destroy();

        picEfficiencyChart = new Chart(ctx2, {
          type: "doughnut",
          data: {
            labels: picData.names,
            datasets: [
              {
                data: picData.efficiency,
                backgroundColor: [
                  "#ff9999",
                  "#66b3ff",
                  "#99ff99",
                  "#ffcc99",
                  "#ff99cc",
                ],
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              title: {
                display: true,
                text: "Efisiensi PIC (%)",
              },
            },
          },
        });
      }

      function analyzeLocation(data, viewType) {
        const locationMap = {};

        data.forEach((item) => {
          const location = item.tempat || "Tidak Ada Lokasi";
          locationMap[location] = (locationMap[location] || 0) + 1;
        });

        const labels = Object.keys(locationMap);
        let chartData = Object.values(locationMap);

        if (viewType === "efficiency") {
          const max = Math.max(...chartData);
          chartData = chartData.map((value) => Math.round((value / max) * 100));
        }

        return { labels, data: chartData };
      }

      function createLocationChart(data, viewType = "usage") {
        const ctx = document.getElementById("locationChart").getContext("2d");
        if (locationChart) locationChart.destroy();

        const locationData = analyzeLocation(data, viewType);

        const config = {
          usage: {
            type: "bar",
            title: "Penggunaan Ruang",
            color: "#667eea",
          },
          efficiency: {
            type: "line",
            title: "Efisiensi Ruang (%)",
            color: "#4ecdc4",
          },
          peak: {
            type: "radar",
            title: "Peak Hours per Lokasi",
            color: "#ff6b6b",
          },
        };

        locationChart = new Chart(ctx, {
          type: config[viewType].type,
          data: {
            labels: locationData.labels,
            datasets: [
              {
                label: config[viewType].title,
                data: locationData.data,
                backgroundColor: config[viewType].color,
                borderColor: config[viewType].color,
                tension: 0.4,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              title: {
                display: true,
                text: config[viewType].title,
              },
            },
          },
        });
      }

      function updateChart() {
        if (chartData.length > 0) {
          createBusyDaysChart(chartData);
        }
      }

      function updatePICAnalysis() {
        if (chartData.length > 0) {
          createPICAnalysis(chartData);
        }
      }

      function switchLocationView(viewType) {
        document
          .querySelectorAll(".tab")
          .forEach((tab) => tab.classList.remove("active"));
        event.target.classList.add("active");

        if (chartData.length > 0) {
          createLocationChart(chartData, viewType);
        }
      }

      function analyzeCapaianData(data, period) {
  const dateRange = getDateRange(period);
  
  const filteredData = data.filter(item => {
    return item.tanggal >= dateRange.start && item.tanggal <= dateRange.end;
  });
  
  const stats = {
    total: filteredData.length,
    selesai: filteredData.filter(item => item.status === 'selesai').length,
    ditunda: filteredData.filter(item => item.status === 'ditunda').length,
    batal: filteredData.filter(item => item.status === 'batal').length,
    belum_selesai: filteredData.filter(item => !item.status || item.status === 'belum_selesai').length
  };
  
  stats.percentage = stats.total > 0 ? Math.round((stats.selesai / stats.total) * 100) : 0;
  
  return { stats, data: filteredData };
}

function createCapaianStatusChart(data) {
  const ctx = document.getElementById('capaianStatusChart');
  if (!ctx) return;
  
  if (capaianStatusChart) {
    capaianStatusChart.destroy();
  }
  
  const period = document.getElementById('capaianPeriod')?.value || 'month';
  const analysis = analyzeCapaianData(data, period);
  
  capaianStatusChart = new Chart(ctx.getContext('2d'), {
    type: 'doughnut',
    data: {
      labels: ['Selesai', 'Ditunda', 'Batal', 'Belum Selesai'],
      datasets: [{
        data: [
          analysis.stats.selesai,
          analysis.stats.ditunda,
          analysis.stats.batal,
          analysis.stats.belum_selesai
        ],
        backgroundColor: ['#28a745', '#ffc107', '#dc3545', '#6c757d'],
        borderWidth: 2,
        borderColor: '#fff'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: {
          display: true,
          text: `Distribusi Status - ${getPeriodName(period)}`
        },
        legend: {
          position: 'bottom'
        }
      }
    }
  });
}

function createCapaianTrendChart(data) {
  const ctx = document.getElementById('capaianTrendChart');
  if (!ctx) return;
  
  if (capaianTrendChart) {
    capaianTrendChart.destroy();
  }
  
  const period = document.getElementById('capaianPeriod')?.value || 'month';
  const dateRange = getDateRange(period);
  
  const filteredData = data.filter(item => {
    return item.tanggal >= dateRange.start && item.tanggal <= dateRange.end;
  });
  
  // Group by date
  const trendData = {};
  filteredData.forEach(item => {
    const date = item.tanggal;
    if (!trendData[date]) {
      trendData[date] = { selesai: 0, total: 0 };
    }
    trendData[date].total++;
    if (item.status === 'selesai') {
      trendData[date].selesai++;
    }
  });
  
  const sortedDates = Object.keys(trendData).sort();
  const labels = sortedDates.map(date => formatDate(date));
  const selesaiData = sortedDates.map(date => trendData[date].selesai);
  const totalData = sortedDates.map(date => trendData[date].total);
  
  capaianTrendChart = new Chart(ctx.getContext('2d'), {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'Total Agenda',
          data: totalData,
          borderColor: '#667eea',
          backgroundColor: 'rgba(102, 126, 234, 0.1)',
          tension: 0.4
        },
        {
          label: 'Agenda Selesai',
          data: selesaiData,
          borderColor: '#28a745',
          backgroundColor: 'rgba(40, 167, 69, 0.1)',
          tension: 0.4
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: {
          display: true,
          text: `Tren Capaian - ${getPeriodName(period)}`
        },
        legend: {
          position: 'bottom'
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            stepSize: 1
          }
        }
      }
    }
  });
}

function updateCapaianMetrics(data) {
  const period = document.getElementById('capaianPeriod')?.value || 'month';
  const analysis = analyzeCapaianData(data, period);
  
  document.getElementById('totalCapaian').textContent = analysis.stats.total;
  document.getElementById('selesaiCapaian').textContent = analysis.stats.selesai;
  document.getElementById('ditundaCapaian').textContent = analysis.stats.ditunda;
  document.getElementById('batalCapaian').textContent = analysis.stats.batal;
  document.getElementById('belumCapaian').textContent = analysis.stats.belum_selesai;
  document.getElementById('percentageCapaian').textContent = `${analysis.stats.percentage}%`;
  
  // Update insight
  const insightText = document.getElementById('insightText');
  if (insightText) {
    let insight = `Dari ${analysis.stats.total} agenda pada ${getPeriodName(period)}, `;
    insight += `${analysis.stats.selesai} agenda (${analysis.stats.percentage}%) telah diselesaikan. `;
    
    if (analysis.stats.percentage >= 80) {
      insight += 'üéâ Performa sangat baik!';
    } else if (analysis.stats.percentage >= 60) {
      insight += 'üëç Performa baik, pertahankan!';
    } else if (analysis.stats.percentage >= 40) {
      insight += '‚ö†Ô∏è Perlu peningkatan fokus.';
    } else {
      insight += 'üîî Perhatian khusus diperlukan.';
    }
    
    if (analysis.stats.ditunda > 0) {
      insight += ` Terdapat ${analysis.stats.ditunda} agenda yang ditunda.`;
    }
    
    insightText.textContent = insight;
  }
}

function updateCapaianDashboard() {
  if (chartData && chartData.length > 0) {
    updateCapaianMetrics(chartData);
    createCapaianStatusChart(chartData);
    createCapaianTrendChart(chartData);
  }
}

      // ===== NAVIGATION FUNCTIONS =====

      function showSection(id) {
        document
          .querySelectorAll(".nav-link")
          .forEach((link) => link.classList.remove("active"));
        if (event && event.target) {
          event.target.classList.add("active");
        }

        document
          .querySelectorAll(".content-section")
          .forEach((section) => section.classList.remove("active"));
        document.getElementById(id).classList.add("active");

        if (window.innerWidth <= 1024) {
          closeSidebar();
        }

        if (id === "kelola") {
          loadAgenda();
          setTimeout(() => {
            initSearch();
          }, 100);
        }

        if (id === "dashboard") {
          loadDashboardStats();
        }

        if (id === "capaian") {
          loadCapaian();
          setTimeout(() => {
            initCapaianSearch();
          }, 100);
        }
        if (id === "admin") {
          loadAdmin();
          setTimeout(() => {
            initAdminSearch();
          }, 100);
        }
        if (id === "ketersediaan") {
  loadKetersediaan();
}
      }

      // ===== SIDEBAR FUNCTIONS =====
      function toggleSidebar() {
        const sidebar = document.getElementById("sidebar");
        const hamburger = document.querySelector(".hamburger-btn");
        const overlay = document.querySelector(".sidebar-overlay");

        sidebar.classList.toggle("active");
        hamburger.classList.toggle("active");
        overlay.classList.toggle("active");
      }

      function closeSidebar() {
        const sidebar = document.getElementById("sidebar");
        const hamburger = document.querySelector(".hamburger-btn");
        const overlay = document.querySelector(".sidebar-overlay");

        sidebar.classList.remove("active");
        hamburger.classList.remove("active");
        overlay.classList.remove("active");
      }

      // ===== CAPAIAN AGENDA VARIABLES =====
      let allCapaianData = [];
      let currentCapaianFilter = "all";
      let searchCapaianQuery = "";

      // ===== CAPAIAN FUNCTIONS =====
      async function loadCapaian() {
        setTableLoading("capaian-table", true);
        console.log("=== LOADING CAPAIAN DATA ===");

        try {
          const response = await fetch(API_ENDPOINTS.GET_AGENDA);
          console.log("Load capaian response status:", response.status);

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          console.log("Raw capaian data from API:", data);
          console.log("Total items loaded:", data.length);

          // Pastikan setiap item memiliki status yang benar
          data.forEach((item, index) => {
            console.log(
              `Item ${index}: ID=${item.id}, Status="${item.status}", Agenda="${item.agenda}"`
            );

            // Jika status null atau undefined, set ke belum_selesai
            if (!item.status) {
              console.log(`Setting default status for item ${item.id}`);
              item.status = "belum_selesai";
            }
          });

          allCapaianData = data || [];
          console.log(
            "Processed capaian data:",
            allCapaianData.length,
            "items"
          );

          displayFilteredCapaian();
        } catch (error) {
          console.error("=== ERROR LOADING CAPAIAN ===");
          console.error("Error details:", error);
          showToast("Gagal memuat data capaian!", "error");
          allCapaianData = [];
          displayFilteredCapaian();
        } finally {
          setTableLoading("capaian-table", false);
        }
      }

      function filterCapaian(type) {
        currentCapaianFilter = type;

        document
          .querySelectorAll("#capaian .filter-tabs .tab")
          .forEach((tab) => {
            tab.classList.remove("active");
          });

        event.target.classList.add("active");
        displayFilteredCapaian();
      }

      function filterCapaianData(data) {
        switch (currentCapaianFilter) {
          case "selesai":
            return data.filter((item) => item.status === "selesai");
          case "ditunda":
            return data.filter((item) => item.status === "ditunda");
          case "batal":
            return data.filter((item) => item.status === "batal");
          case "belum_selesai":
            return data.filter(
              (item) => !item.status || item.status === "belum_selesai"
            );
          default:
            return data;
        }
      }

      function searchCapaian(data, query) {
        if (!query || query.length === 0) return data;

        return data.filter((item) => {
          const searchableFields = [
            item.agenda || "",
            item.pic || "",
            item.tempat || "",
            item.tanggal || "",
          ];

          const searchableText = searchableFields.join(" ").toLowerCase();
          const queryWords = query.split(" ").filter((word) => word.length > 0);

          return queryWords.every((word) => searchableText.includes(word));
        });
      }

      function displayFilteredCapaian() {
        const tbody = document.querySelector("#capaian-table tbody");
        const searchStats = document.getElementById("searchCapaianStats");

        if (!tbody) return;

        let filteredData = filterCapaianData(allCapaianData);

        if (searchCapaianQuery && searchCapaianQuery.length > 0) {
          filteredData = searchCapaian(filteredData, searchCapaianQuery);
        }

        // Sort data by date and time (descending)
        filteredData = sortAgendaByDateTime(filteredData);

        tbody.innerHTML = "";

        if (filteredData.length === 0) {
          const noResultsMessage = searchCapaianQuery
            ? `Tidak ditemukan agenda yang sesuai dengan "${searchCapaianQuery}"`
            : "Tidak ada agenda untuk filter yang dipilih";

          tbody.innerHTML = `
      <tr>
        <td colspan="6" class="no-results">
          <div class="no-results-icon">üìã</div>
          <div>${noResultsMessage}</div>
        </td>
      </tr>
    `;

          updateCapaianSearchStats(searchStats, 0, allCapaianData.length);
          return;
        }

        // Debug log untuk melihat status setiap item
        console.log(
          "Filtered capaian data:",
          filteredData.map((item) => ({
            id: item.id,
            agenda: item.agenda,
            status: item.status,
          }))
        );

        filteredData.forEach((row) => {
          const statusBadge = getStatusBadge(row.status || "belum_selesai");

          const tr = document.createElement("tr");
          tr.innerHTML = `
      <td title="${formatDate(row.tanggal)}">${highlightText(
            formatDate(row.tanggal),
            searchCapaianQuery
          )}</td>
      <td title="${row.jam}">${highlightText(row.jam, searchCapaianQuery)}</td>
      <td title="${row.agenda}">${highlightText(
            row.agenda,
            searchCapaianQuery
          )}</td>
      <td title="${row.pic || "Tidak ada PIC"}">${highlightText(
            row.pic || "Tidak ada PIC",
            searchCapaianQuery
          )}</td>
      <td>${statusBadge}</td>
<td>
  ${
    row.status === "selesai"
      ? `<button onclick='viewCapaianDetail(${JSON.stringify(row).replace(
          /'/g,
          "&#39;"
        )})' class="btn btn-secondary">Detail</button>`
      : `<button onclick='updateCapaian(${JSON.stringify(row).replace(
          /'/g,
          "&#39;"
        )})' class="btn btn-primary">Update</button>`
  }
</td>
    `;
          tbody.appendChild(tr);
        });

        updateCapaianSearchStats(
          searchStats,
          filteredData.length,
          allCapaianData.length
        );
      }

      function viewCapaianDetail(data) {
        console.log("View capaian detail for ID:", data.id);

        if (!data || !data.id) {
          showToast("Data agenda tidak valid!", "error");
          return;
        }

        showSection("capaian");
        const form = document.getElementById("capaianForm");

        if (!form) {
          showToast("Form tidak ditemukan!", "error");
          return;
        }

        form.classList.remove("hidden");

        // Fill form data dalam mode read-only
        document.getElementById("capaian-id").value = data.id;
        document.getElementById("capaian-agenda").value = data.agenda || "";
        document.getElementById("capaian-tanggal").value =
          formatDate(data.tanggal) || "";
        document.getElementById("capaian-pic").value =
          data.pic || "Tidak ada PIC";
        document.getElementById("capaian-status").value =
          data.status || "belum_selesai";
        document.getElementById("capaian-keterangan").value =
          data.keterangan || "";

        // Disable all form inputs untuk mode detail
        const formInputs = form.querySelectorAll("input, select, textarea");
        formInputs.forEach((input) => {
          input.disabled = true;
          input.style.background = "#f5f5f5";
        });

        // Hide file input untuk mode detail, tapi tetap tampilkan preview foto
        const fotoInput = document
          .getElementById("capaian-foto")
          .closest(".form-group");
        if (fotoInput) {
          // Hanya sembunyikan input file, bukan seluruh form group
          const fileInput = document.getElementById("capaian-foto");
          const fileLabel = fotoInput.querySelector("label");
          const fileSmall = fotoInput.querySelector("small");

          if (fileInput) fileInput.style.display = "none";
          if (fileLabel) fileLabel.style.display = "none";
          if (fileSmall) fileSmall.style.display = "none";
        }

        // Handle existing photo display
        const currentFoto = document.getElementById("current-foto");
        const currentFotoPreview = document.getElementById(
          "current-foto-preview"
        );
        // Ubah label foto untuk mode detail
        const currentFotoElement = document.getElementById("current-foto");
        if (currentFotoElement) {
          const fotoLabel = currentFotoElement.querySelector("p");
          if (fotoLabel) {
            fotoLabel.textContent = "Dokumentasi:";
          }
        }

        if (currentFoto && currentFotoPreview) {
          if (data.foto) {
            currentFoto.classList.remove("hidden");
            currentFotoPreview.src = data.foto;
            // Show foto dengan ukuran lebih besar untuk detail view
            currentFotoPreview.style.maxWidth = "400px";
            currentFotoPreview.style.maxHeight = "300px";
          } else {
            currentFoto.classList.add("hidden");
          }
        }

        // Update form header
        const formHeader = form.querySelector("h3");
        if (formHeader) {
          formHeader.textContent = "Detail Capaian Agenda";
        }

        // Hide submit button, hanya tampilkan tombol tutup
        const submitBtn = form.querySelector('button[type="submit"]');
        if (submitBtn) {
          submitBtn.style.display = "none";
        }

        // Update cancel button text dan tambah print button HANYA untuk agenda selesai
        const cancelBtn = form.querySelector("button.btn-secondary");
        if (cancelBtn) {
          cancelBtn.textContent = "Tutup";

          // Hapus print button yang ada (jika ada)
          const existingPrintBtn = cancelBtn.nextElementSibling;
          if (
            existingPrintBtn &&
            existingPrintBtn.classList.contains("btn-print")
          ) {
            existingPrintBtn.remove();
          }

          // Tambah print button HANYA jika status selesai
          if (data.status === "selesai") {
            const printBtn = document.createElement("button");
            printBtn.type = "button";
            printBtn.className = "btn btn-info btn-print";
            printBtn.textContent = "Cetak PDF";
            printBtn.onclick = () => generatePDF(data);
            cancelBtn.parentNode.insertBefore(printBtn, cancelBtn.nextSibling);
          }
        }

        // Scroll to form
        setTimeout(() => {
          form.scrollIntoView({
            behavior: "smooth",
            block: "start",
          });
        }, 100);
      }

      function getStatusBadge(status) {
        const statusMap = {
          selesai: { text: "Selesai", class: "status-selesai" },
          ditunda: { text: "Ditunda", class: "status-ditunda" },
          batal: { text: "Batal", class: "status-batal" },
          belum_selesai: {
            text: "Belum Selesai",
            class: "status-belum_selesai",
          },
        };

        const statusInfo = statusMap[status] || statusMap["belum_selesai"];
        return `<span class="status-badge ${statusInfo.class}">${statusInfo.text}</span>`;
      }

      // ===== CLEANED UP CAPAIAN FUNCTIONS =====


document.addEventListener("DOMContentLoaded", function () {
  updateAdminInfo(); // Tambahkan ini
  loadDashboardStats();
  initSearch();
});

      // Simplified updateCapaian function
      function updateCapaian(data) {
        console.log("Update capaian called for ID:", data.id);

        if (!data || !data.id) {
          showToast("Data agenda tidak valid!", "error");
          return;
        }

        showSection("capaian");
        const form = document.getElementById("capaianForm");

        if (!form) {
          showToast("Form tidak ditemukan!", "error");
          return;
        }

        // TAMBAHKAN: Reset form ke mode normal dulu
        const formInputs = form.querySelectorAll("input, select, textarea");
        formInputs.forEach((input) => {
          input.disabled = false;
          input.style.background = "";
        });

        // Show file input
        const fotoInput = document
          .getElementById("capaian-foto")
          .closest(".form-group");
        if (fotoInput) {
          fotoInput.style.display = "";
        }

        // Reset form header
        const formHeader = form.querySelector("h3");
        if (formHeader) {
          formHeader.textContent = "Update Capaian Agenda";
        }

        // Show submit button
        const submitBtn = form.querySelector('button[type="submit"]');
        if (submitBtn) {
          submitBtn.style.display = "";
        }

        // Reset cancel button text
        const cancelBtn = form.querySelector("button.btn-secondary");
        if (cancelBtn) {
          cancelBtn.textContent = "Batal";
        }

        form.classList.remove("hidden");

        // Fill form data
        document.getElementById("capaian-id").value = data.id;
        document.getElementById("capaian-agenda").value = data.agenda || "";
        document.getElementById("capaian-tanggal").value =
          formatDate(data.tanggal) || "";
        document.getElementById("capaian-pic").value =
          data.pic || "Tidak ada PIC";
        document.getElementById("capaian-status").value =
          data.status || "belum_selesai";
        document.getElementById("capaian-keterangan").value =
          data.keterangan || "";

        // Handle existing photo
        const currentFoto = document.getElementById("current-foto");
        const currentFotoPreview = document.getElementById(
          "current-foto-preview"
        );

        if (currentFoto && currentFotoPreview) {
          if (data.foto) {
            currentFoto.classList.remove("hidden");
            currentFotoPreview.src = data.foto;
            // Reset ukuran foto ke normal untuk update mode
            currentFotoPreview.style.maxWidth = "200px";
            currentFotoPreview.style.maxHeight = "150px";
          } else {
            currentFoto.classList.add("hidden");
          }
        }

        // Scroll to form
        setTimeout(() => {
          form.scrollIntoView({
            behavior: "smooth",
            block: "start",
          });
        }, 100);
      }

      // Keep the existing helper functions as they are
      function cancelCapaian() {
        const form = document.getElementById("capaianForm");

        // Reset form ke mode normal (enable semua input)
        if (form) {
          const formInputs = form.querySelectorAll("input, select, textarea");
          formInputs.forEach((input) => {
            input.disabled = false;
            input.style.background = "";
          });

          // Show kembali file input
          const fotoInput = document
            .getElementById("capaian-foto")
            .closest(".form-group");
          if (fotoInput) {
            // Tampilkan kembali semua elemen form file
            const fileInput = document.getElementById("capaian-foto");
            const fileLabel = fotoInput.querySelector("label");
            const fileSmall = fotoInput.querySelector("small");

            if (fileInput) fileInput.style.display = "";
            if (fileLabel) fileLabel.style.display = "";
            if (fileSmall) fileSmall.style.display = "";
          }

          // Reset form header
          const formHeader = form.querySelector("h3");
          if (formHeader) {
            formHeader.textContent = "Update Capaian Agenda";
          }

          // Show kembali submit button
          const submitBtn = form.querySelector('button[type="submit"]');
          if (submitBtn) {
            submitBtn.style.display = "";
          }

          // Reset cancel button text
          const cancelBtn = form.querySelector("button.btn-secondary");
          if (cancelBtn) {
            cancelBtn.textContent = "Batal";
          }

          // Reset foto preview size
          const currentFotoPreview = document.getElementById(
            "current-foto-preview"
          );
          if (currentFotoPreview) {
            currentFotoPreview.style.maxWidth = "200px";
            currentFotoPreview.style.maxHeight = "150px";
          }
        }

        document.getElementById("capaianForm").classList.add("hidden");
        document.getElementById("capaian-foto").value = "";
        setTimeout(() => {
          window.scrollTo({
            top: 0,
            behavior: "smooth",
          });
        }, 100);

        // Reset label foto
        const currentFotoElement = document.getElementById("current-foto");
        if (currentFotoElement) {
          const fotoLabel = currentFotoElement.querySelector("p");
          if (fotoLabel) {
            fotoLabel.textContent = "Foto saat ini:";
          }
        }
      }

      function fileToBase64(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = (error) => reject(new Error("Gagal membaca file"));
          reader.readAsDataURL(file);
        });
      }
      function debugCapaianForm() {
        console.log("=== DEBUGGING CAPAIAN FORM ===");

        const formElements = [
          "capaian-id",
          "capaian-agenda",
          "capaian-tanggal",
          "capaian-pic",
          "capaian-status",
          "capaian-keterangan",
          "capaian-foto",
        ];

        formElements.forEach((id) => {
          const element = document.getElementById(id);
          if (element) {
            console.log(
              `${id}: ${element.value || element.files?.length || "empty"}`
            );
          } else {
            console.error(`Missing element: ${id}`);
          }
        });

        console.log("All capaian data:", allCapaianData.length, "items");
        console.log("Current filter:", currentCapaianFilter);
        console.log("Search query:", searchCapaianQuery);
      }

      async function submitCapaian(e) {
        e.preventDefault();
        const submitBtn = e.target.querySelector('button[type="submit"]');
        setButtonLoading(submitBtn, true, "Menyimpan...");

        const id = document.getElementById("capaian-id").value;
        const status = document.getElementById("capaian-status").value;
        const keterangan = document.getElementById("capaian-keterangan").value;
        const fotoFile = document.getElementById("capaian-foto").files[0];

        console.log("=== DEBUG SUBMIT CAPAIAN START ===");
        console.log("Form elements:");
        console.log("- ID:", id, typeof id);
        console.log("- Status:", status, typeof status);
        console.log("- Keterangan:", keterangan, typeof keterangan);
        console.log("- File:", fotoFile ? fotoFile.name : "No file");

        // Validasi ID
        if (!id || isNaN(parseInt(id))) {
          console.error("Invalid ID:", id);
          showToast("ID agenda tidak valid!", "error");
          setButtonLoading(submitBtn, false);
          return;
        }

        // Validasi status
        const validStatuses = ["selesai", "ditunda", "batal", "belum_selesai"];
        if (!validStatuses.includes(status)) {
          console.error("Invalid status:", status);
          showToast("Status tidak valid!", "error");
          setButtonLoading(submitBtn, false);
          return;
        }

        try {
          let fotoData = null;

          // Handle file upload if exists
          if (fotoFile) {
            console.log("Processing file upload...");

            // Validate file size (5MB max)
            if (fotoFile.size > 5 * 1024 * 1024) {
              showToast("Ukuran file terlalu besar! Maksimal 5MB", "error");
              setButtonLoading(submitBtn, false);
              return;
            }

            // Validate file type
            const allowedTypes = [
              "image/jpeg",
              "image/jpg",
              "image/png",
              "image/gif",
            ];
            if (!allowedTypes.includes(fotoFile.type)) {
              showToast(
                "Format file tidak didukung! Gunakan JPG, PNG, atau GIF",
                "error"
              );
              setButtonLoading(submitBtn, false);
              return;
            }

            try {
              fotoData = await fileToBase64(fotoFile);
              console.log("File converted to base64, length:", fotoData.length);
            } catch (error) {
              console.error("Error converting file:", error);
              showToast("Gagal memproses file gambar!", "error");
              setButtonLoading(submitBtn, false);
              return;
            }
          }

          // Ambil data agenda yang sudah ada terlebih dahulu
          const currentAgenda = allCapaianData.find((item) => item.id == id);
          if (!currentAgenda) {
            console.error("Current agenda not found for ID:", id);
            console.log(
              "Available agenda IDs:",
              allCapaianData.map((item) => item.id)
            );
            console.log("All capaian data length:", allCapaianData.length);

            // Coba reload data dulu sebelum gagal
            console.log("Attempting to reload data...");
            await loadCapaian();

            // Coba cari lagi setelah reload
            const reloadedAgenda = allCapaianData.find((item) => item.id == id);
            if (!reloadedAgenda) {
              showToast("Data agenda tidak ditemukan setelah reload!", "error");
              setButtonLoading(submitBtn, false);
              return;
            }
            console.log("Found agenda after reload:", reloadedAgenda);
            currentAgenda = reloadedAgenda;
          }

          console.log("Current agenda found:", {
            id: currentAgenda.id,
            agenda: currentAgenda.agenda,
            status: currentAgenda.status,
          });

          // Prepare data untuk dikirim
          const updateData = {
            id: parseInt(id),
            tanggal: currentAgenda.tanggal,
            jam: currentAgenda.jam,
            agenda: currentAgenda.agenda,
            pic: currentAgenda.pic,
            tempat: currentAgenda.tempat,
            status: status,
            keterangan: keterangan || null, // Allow empty keterangan
            updated_by: getLoggedInAdminName()
          };

          // Only include foto if there's new upload or existing foto
          if (fotoData) {
            updateData.foto = fotoData;
          } else if (currentAgenda.foto) {
            updateData.foto = currentAgenda.foto; // Keep existing foto
          }

          console.log("=== DATA TO BE SENT ===");
          console.log("Update data:", {
            ...updateData,
            foto: updateData.foto
              ? `[Base64 data - ${updateData.foto.length} chars]`
              : "null",
          });

          // Send request
          console.log("Sending PATCH request to /api/edit-agenda...");
          const response = await fetch("/api/edit-agenda", {
            method: "PATCH",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(updateData),
          });

          console.log("=== RESPONSE RECEIVED ===");
          console.log("Status:", response.status);
          console.log("Status text:", response.statusText);
          console.log(
            "Headers:",
            Object.fromEntries(response.headers.entries())
          );

          // Get response text first for debugging
          const responseText = await response.text();
          console.log("Raw response text:", responseText);

          // Check if response is ok
          if (!response.ok) {
            console.error("Server error response:", responseText);

            let errorMessage = `HTTP ${response.status}: ${response.statusText}`;

            // Try to parse error message from response
            try {
              const errorJson = JSON.parse(responseText);
              if (errorJson.error) {
                errorMessage = errorJson.error;
              }
              if (errorJson.details) {
                errorMessage += ` (${errorJson.details})`;
              }
            } catch (e) {
              console.log("Response is not valid JSON, using raw text");
              if (responseText) {
                errorMessage = responseText;
              }
            }

            throw new Error(errorMessage);
          }

          // Parse successful response
          let result;
          try {
            result = JSON.parse(responseText);
            console.log("Parsed response:", result);
          } catch (e) {
            console.warn(
              "Response is not JSON but request was successful:",
              responseText
            );
            result = { success: true, message: "Update berhasil" };
          }

          // Check for application-level errors
          if (result.error) {
            throw new Error(result.error);
          }

          console.log("=== UPDATE SUCCESSFUL ===");
          showToast("Capaian agenda berhasil diupdate!", "success");

          // Cancel form
          cancelCapaian();

          // Reload data dengan delay untuk memastikan server sudah update
          console.log("Reloading data...");
          setTimeout(async () => {
            try {
              await loadCapaian();
              await loadDashboardStats();
              console.log("Data reloaded successfully");
            } catch (error) {
              console.error("Error reloading data:", error);
            }
          }, 500);

          // Scroll to top
          setTimeout(() => {
            window.scrollTo({
              top: 0,
              behavior: "smooth",
            });
          }, 200);
        } catch (error) {
          console.error("=== ERROR SUBMIT CAPAIAN ===");
          console.error("Error message:", error.message);
          console.error("Error stack:", error.stack);

          let errorMessage = "Gagal mengupdate capaian";
          if (error.message && !error.message.includes("Failed to fetch")) {
            errorMessage += `: ${error.message}`;
          } else if (
            error.message &&
            error.message.includes("Failed to fetch")
          ) {
            errorMessage =
              "Gagal terhubung ke server. Periksa koneksi internet Anda.";
          }

          showToast(errorMessage, "error");
        } finally {
          setButtonLoading(submitBtn, false);
          console.log("=== DEBUG SUBMIT CAPAIAN END ===");
        }
      }

      // Helper function to convert file to base64
      function fileToBase64(file) {
        return new Promise((resolve, reject) => {
          console.log(
            "Converting file to base64:",
            file.name,
            file.size,
            "bytes"
          );

          const reader = new FileReader();

          reader.onload = () => {
            console.log("File conversion successful");
            resolve(reader.result);
          };

          reader.onerror = (error) => {
            console.error("File conversion error:", error);
            reject(new Error("Gagal membaca file"));
          };

          reader.onabort = () => {
            console.error("File conversion aborted");
            reject(new Error("Pembacaan file dibatalkan"));
          };

          try {
            reader.readAsDataURL(file);
          } catch (error) {
            console.error("Error starting file read:", error);
            reject(error);
          }
        });
      }
      // ===== PDF GENERATION FUNCTION =====
      function generatePDF(data) {
        console.log("Generating PDF for agenda:", data.id);

        // Inisialisasi jsPDF
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF();

        // Set font
        pdf.setFont("helvetica");

        // ===== TAMBAHKAN KOP SURAT =====
        let yPosition = addKopSurat(pdf);
        
        const leftMargin = 20;
        const rightMargin = 190;
        const lineHeight = 8;

        // Title Dokumen
        pdf.setFontSize(16);
        pdf.setFont('helvetica', 'bold');
        pdf.setTextColor(51, 51, 51);
        pdf.text("LAPORAN CAPAIAN AGENDA", 105, yPosition, { align: "center" });

        yPosition += 8;
        pdf.setFontSize(10);
        pdf.setFont('helvetica', 'normal');
        pdf.setTextColor(100, 100, 100);
        pdf.text("Sistem Manajemen Agenda Kantor (AKITA)", 105, yPosition, {
          align: "center",
        });

        // Garis pembatas
        yPosition += 8;
        pdf.setDrawColor(200, 200, 200);
        pdf.setLineWidth(0.3);
        pdf.line(leftMargin, yPosition, rightMargin, yPosition);

        yPosition += 12;

        // Informasi Agenda
        pdf.setFontSize(14);
        pdf.setTextColor(51, 51, 51);
        pdf.text("INFORMASI AGENDA", leftMargin, yPosition);

        yPosition += 12;
        pdf.setFontSize(10);

        const agendaFields = [
          { label: "Agenda", value: data.agenda || "-" },
          { label: "Tanggal", value: formatDate(data.tanggal) || "-" },
          { label: "Jam", value: data.jam || "-" },
          { label: "PIC", value: data.pic || "Tidak ada PIC" },
          { label: "Tempat", value: data.tempat || "Tidak ada lokasi" },
        ];

        agendaFields.forEach((field) => {
          pdf.setFont("helvetica", "bold");
          pdf.text(`${field.label}:`, leftMargin, yPosition);
          pdf.setFont("helvetica", "normal");

          // Handle text wrapping untuk value yang panjang
          const textLines = pdf.splitTextToSize(
            field.value,
            rightMargin - leftMargin - 40
          );
          pdf.text(textLines, leftMargin + 40, yPosition);
          yPosition += textLines.length * lineHeight;
        });

        yPosition += 10;

        // Status Capaian
        pdf.setFontSize(14);
        pdf.setFont("helvetica", "bold");
        pdf.text("STATUS CAPAIAN", leftMargin, yPosition);

        yPosition += 12;
        pdf.setFontSize(10);

        // Status dengan styling
        const statusInfo = getStatusInfo(data.status);
        pdf.setFont("helvetica", "bold");
        pdf.text("Status:", leftMargin, yPosition);

        // Set warna berdasarkan status
        pdf.setTextColor(
          statusInfo.color.r,
          statusInfo.color.g,
          statusInfo.color.b
        );
        pdf.text(statusInfo.text, leftMargin + 40, yPosition);

        yPosition += 12;

        // Keterangan
        if (data.keterangan && data.keterangan.trim()) {
          pdf.setTextColor(51, 51, 51);
          pdf.setFont("helvetica", "bold");
          pdf.text("Keterangan:", leftMargin, yPosition);
          yPosition += lineHeight;

          pdf.setFont("helvetica", "normal");
          const keteranganLines = pdf.splitTextToSize(
            data.keterangan,
            rightMargin - leftMargin
          );
          pdf.text(keteranganLines, leftMargin, yPosition);
          yPosition += keteranganLines.length * lineHeight + 10;
        }

        // Dokumentasi Foto
        if (data.foto) {
          // Cek apakah masih ada ruang untuk foto
          if (yPosition > 200) {
            pdf.addPage();
            yPosition = 30;
          }

          pdf.setFontSize(14);
          pdf.setFont("helvetica", "bold");
          pdf.text("DOKUMENTASI", leftMargin, yPosition);
          yPosition += 15;

          try {
            // Tambahkan foto ke PDF
            const imgWidth = 120;
            const imgHeight = 90;
            const imgX = (210 - imgWidth) / 2; // Center horizontally

            pdf.addImage(
              data.foto,
              "JPEG",
              imgX,
              yPosition,
              imgWidth,
              imgHeight
            );
            yPosition += imgHeight + 20;
          } catch (error) {
            console.error("Error adding image to PDF:", error);
            pdf.setFontSize(10);
            pdf.setTextColor(150, 150, 150);
            pdf.text("Gagal memuat gambar dokumentasi", leftMargin, yPosition);
            yPosition += 15;
          }
        }

        // Footer
        const currentDate = new Date();
        const footerText = `Dicetak pada: ${currentDate.toLocaleDateString(
          "id-ID",
          {
            weekday: "long",
            year: "numeric",
            month: "long",
            day: "numeric",
            hour: "2-digit",
            minute: "2-digit",
          }
        )}`;

        pdf.setFontSize(8);
        pdf.setTextColor(100, 100, 100);
        pdf.text(footerText, 105, 280, { align: "center" });

        // Generate filename
        const agendaName = data.agenda
          ? data.agenda.substring(0, 30).replace(/[^a-zA-Z0-9]/g, "_")
          : "agenda";
        const dateStr = data.tanggal
          ? data.tanggal.replace(/-/g, "")
          : new Date().toISOString().split("T")[0].replace(/-/g, "");
        const filename = `Laporan_${agendaName}_${dateStr}.pdf`;

        // Download PDF
        pdf.save(filename);

        showToast("PDF berhasil diunduh!", "success");
      }

     function printCapaianDashboard() {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();
  
  const period = document.getElementById('capaianPeriod')?.value || 'month';
  const periodName = getPeriodName(period);
  const analysis = analyzeCapaianData(chartData, period);
  
  // ===== TAMBAHKAN KOP SURAT =====
  let yPos = addKopSurat(pdf);
  
  const leftMargin = 20;
  const rightMargin = 190;
  const lineHeight = 8;
  
  // Title Dokumen
  pdf.setFontSize(16);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(51, 51, 51);
  pdf.text('LAPORAN CAPAIAN AGENDA', 105, yPos, { align: 'center' });
  
  yPos += 8;
  pdf.setFontSize(13);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(102, 126, 234);
  pdf.text(periodName, 105, yPos, { align: 'center' });
  
  yPos += 7;
  pdf.setFontSize(9);
  pdf.setFont('helvetica', 'normal');
  pdf.setTextColor(100, 100, 100);
  const reportDate = new Date().toLocaleDateString('id-ID', { 
    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
  });
  pdf.text(`Dicetak: ${reportDate}`, 105, yPos, { align: 'center' });
  
  // Line
  yPos += 8;
  pdf.setDrawColor(200, 200, 200);
  pdf.setLineWidth(0.3);
  pdf.line(leftMargin, yPos, rightMargin, yPos);
  
  yPos += 12;
  
  // Ringkasan Statistik
  pdf.setFontSize(14);
  pdf.setTextColor(51, 51, 51);
  pdf.setFont('helvetica', 'bold');
  pdf.text('RINGKASAN STATISTIK', leftMargin, yPos);
  
  yPos += 12;
  pdf.setFontSize(11);
  pdf.setFont('helvetica', 'normal');
  
  const stats = [
    { label: 'Total Agenda', value: analysis.stats.total, color: [102, 126, 234] },
    { label: 'Selesai', value: analysis.stats.selesai, color: [40, 167, 69] },
    { label: 'Ditunda', value: analysis.stats.ditunda, color: [255, 193, 7] },
    { label: 'Batal', value: analysis.stats.batal, color: [220, 53, 69] },
    { label: 'Belum Selesai', value: analysis.stats.belum_selesai, color: [108, 117, 125] },
    { label: 'Persentase Selesai', value: `${analysis.stats.percentage}%`, color: [102, 126, 234] }
  ];
  
  stats.forEach(stat => {
    pdf.setTextColor(51, 51, 51);
    pdf.text(`${stat.label}:`, leftMargin, yPos);
    pdf.setFont('helvetica', 'bold');
    pdf.setTextColor(stat.color[0], stat.color[1], stat.color[2]);
    pdf.text(String(stat.value), leftMargin + 60, yPos);
    pdf.setFont('helvetica', 'normal');
    yPos += 10;
  });
  
  yPos += 10;
  
  // Insight
  pdf.setFontSize(14);
  pdf.setTextColor(51, 51, 51);
  pdf.setFont('helvetica', 'bold');
  pdf.text('ANALISIS & INSIGHT', leftMargin, yPos);
  
  yPos += 12;
  pdf.setFontSize(10);
  pdf.setFont('helvetica', 'normal');
  
  const insightText = document.getElementById('insightText')?.textContent || 'Tidak ada insight tersedia.';
  const insightLines = pdf.splitTextToSize(insightText, rightMargin - leftMargin);
  pdf.text(insightLines, leftMargin, yPos);
  yPos += insightLines.length * 7 + 15;
  
  // Detail Agenda (if space available)
  if (yPos < 220 && analysis.data.length > 0) {
    pdf.setFontSize(14);
    pdf.setFont('helvetica', 'bold');
    pdf.text('DETAIL AGENDA', leftMargin, yPos);
    yPos += 12;
    
    pdf.setFontSize(9);
    pdf.setFont('helvetica', 'normal');
    
    const maxItems = Math.floor((270 - yPos) / 10);
    const displayData = analysis.data.slice(0, maxItems);
    
    displayData.forEach((item, index) => {
      if (yPos > 270) return;
      
      const statusInfo = getStatusInfo(item.status || 'belum_selesai');
      const line = `${index + 1}. ${formatDate(item.tanggal)} - ${item.agenda} [${statusInfo.text}]`;
      const lines = pdf.splitTextToSize(line, rightMargin - leftMargin);
      
      if (yPos + (lines.length * 7) > 270) {
        pdf.text('... (lihat sistem untuk detail lengkap)', leftMargin, yPos);
        return;
      }
      
      pdf.text(lines, leftMargin, yPos);
      yPos += lines.length * 7 + 3;
    });
    
    if (analysis.data.length > maxItems) {
      yPos += 5;
      pdf.setTextColor(100, 100, 100);
      pdf.text(`... dan ${analysis.data.length - maxItems} agenda lainnya`, leftMargin, yPos);
    }
  }
  
  // Footer
  pdf.setFontSize(8);
  pdf.setTextColor(100, 100, 100);
  pdf.text('Sistem Manajemen Agenda Kantor (AKITA)', 105, 285, { align: 'center' });
  
  // Save PDF
  const filename = `Laporan_Capaian_${periodName.replace(/ /g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
  pdf.save(filename);
  
  showToast('Laporan berhasil dicetak!', 'success');
}

      // Helper function untuk mendapatkan info status
      function getStatusInfo(status) {
        const statusMap = {
          selesai: { text: "SELESAI", color: { r: 21, g: 87, b: 36 } },
          ditunda: { text: "DITUNDA", color: { r: 133, g: 100, b: 4 } },
          batal: { text: "DIBATALKAN", color: { r: 114, g: 28, b: 36 } },
          belum_selesai: {
            text: "BELUM SELESAI",
            color: { r: 56, g: 61, b: 65 },
          },
        };

        return statusMap[status] || statusMap["belum_selesai"];
      }

      // ===== KOP SURAT FUNCTION =====
      function addKopSurat(pdf, startY = 15) {
        const leftMargin = 20;
        const rightMargin = 190;
        const pageWidth = 210; // A4 width in mm
        let yPos = startY;
        
        // Optional: Tambahkan logo di kiri (jika ada file logo)
        // Uncomment dan ganti dengan base64 logo Anda
        /*
        const logoBase64 = 'data:image/png;base64,iVBORw0KGgo...';
        try {
          pdf.addImage(logoBase64, 'PNG', leftMargin, yPos, 18, 18);
        } catch (e) {
          console.log('Logo tidak dapat dimuat');
        }
        */
       // Logo Kemenkeu
         const logoPath = 'kemenkeu.png'; // atau './assets/images/kemenkeu.png'
  const logoWidth = 22;
  const logoHeight = 22;
  let hasLogo = false;

        try {
          pdf.addImage(logoBase64, 'PNG', leftMargin, yPos, logoWidth, logoHeight);
          hasLogo = true;
          console.log('Logo berhasil ditambahkan');
        } catch (e) {
          console.log('Logo tidak dapat dimuat:', e);
        }
        
        // ===== HITUNG MARGIN KIRI UNTUK TEXT =====
        // Jika ada logo, text dimulai setelah logo + spacing
        // Jika tidak ada logo, text tetap di posisi normal
        const textLeftMargin = hasLogo ? leftMargin + logoWidth + 8 : leftMargin;
        const textRightMargin = rightMargin - 5;
        const textWidth = textRightMargin - textLeftMargin;
        const textCenterX = textLeftMargin + (textWidth / 2);
        
        // Header Text - Baris 1

        pdf.setFontSize(13);
        pdf.setFont('helvetica', 'bold');
        pdf.setTextColor(0, 0, 0);
        pdf.text('KEMENTRIAN KEUANGAN REPUBLIK INDONESIA', pageWidth / 2, yPos, { 
          align: 'center' 
        });
        yPos += 5;
        pdf.setFontSize(11);
        pdf.setFont('helvetica', 'bold');
        pdf.setTextColor(0, 0, 0);
        pdf.text('DIREKTORAT JENDERAL PERBENDAHARAAN', pageWidth / 2, yPos, { 
          align: 'center' 
        });
        yPos += 4.5;
        
        // Baris 2
        pdf.setFontSize(11);
        pdf.text('KANTOR WILAYAH DIREKTORAT JENDERAL PERBENDAHARAAN PROVINSI', pageWidth / 2, yPos, { 
          align: 'center' 
        });
        yPos += 4;
        
        // Baris 3
        pdf.text('JAWA TENGAH', pageWidth / 2, yPos, { 
          align: 'center' 
        });
        yPos += 4;
        
        // Baris 4 - Nama Kantor (lebih besar dan bold)
        pdf.setFontSize(11);
        pdf.setFont('helvetica', 'bold');
        pdf.text('KANTOR PELAYANAN PERBENDAHARAAN NEGARA TIPE A1 PEKALONGAN', pageWidth / 2, yPos, { 
          align: 'center' 
        });
        yPos += 3.5;
        
        // Alamat - font lebih kecil dan normal
        pdf.setFontSize(8);
        pdf.setFont('helvetica', 'normal');
        pdf.text('JALAN BAHAGIA NO. 44, PEKALONGAN 51117 TELEPON (0285) 421476; FAKSIMILE (0285) 421479', pageWidth / 2, yPos, { 
          align: 'center' 
        });
        yPos += 3.5;
       
               
        pdf.text('LAMAN www.djpb.kemenkeu.go.id/kppn/pekalongan', pageWidth / 2, yPos, { 
          align: 'center' 
        });
        yPos += 4
        
        // Garis pembatas (double line seperti di dokumen asli)
        pdf.setDrawColor(0, 0, 0);
        pdf.setLineWidth(1);
        pdf.line(leftMargin, yPos, rightMargin, yPos);
        
        
        // Return posisi Y setelah kop surat untuk melanjutkan konten
        return yPos + 8;
      }

      // ===== CAPAIAN SEARCH FUNCTIONS =====
      function initCapaianSearch() {
        const searchInput = document.getElementById("searchCapaianInput");
        const searchClear = document.getElementById("searchCapaianClear");

        if (!searchInput || !searchClear) return;

        searchInput.addEventListener("input", handleCapaianSearchInput);
        searchClear.style.display = "none";
      }

      const handleCapaianSearchInput = debounce(function (event) {
        searchCapaianQuery = event.target.value.toLowerCase().trim();
        const searchClear = document.getElementById("searchCapaianClear");

        if (searchCapaianQuery.length > 0) {
          searchClear.style.display = "block";
        } else {
          searchClear.style.display = "none";
        }

        displayFilteredCapaian();
      }, 300);

      function clearCapaianSearch() {
        const searchInput = document.getElementById("searchCapaianInput");
        const searchClear = document.getElementById("searchCapaianClear");
        const searchStats = document.getElementById("searchCapaianStats");

        if (searchInput) searchInput.value = "";
        if (searchClear) searchClear.style.display = "none";
        if (searchStats) searchStats.textContent = "";

        searchCapaianQuery = "";
        displayFilteredCapaian();
      }

      function updateCapaianSearchStats(searchStats, totalResults, totalData) {
        if (!searchStats) return;

        if (searchCapaianQuery && searchCapaianQuery.length > 0) {
          searchStats.textContent = `Menampilkan ${totalResults} dari ${totalData} agenda`;
        } else {
          searchStats.textContent = "";
        }
      }

      // ===== UPDATE EXISTING SHOWSECTION FUNCTION =====

      // ===== EVENT LISTENERS =====
document.addEventListener("DOMContentLoaded", function () {
  updateAdminInfo();
  loadDashboardStats();
  initSearch();
});

      document.querySelectorAll(".nav-link").forEach((link) => {
        link.addEventListener("click", () => {
          if (window.innerWidth <= 1024) {
            closeSidebar();
          }
        });
      });

      window.addEventListener("resize", () => {
        if (window.innerWidth > 1024) {
          closeSidebar();
        }
      });

      // ===== ADMIN MANAGEMENT VARIABLES =====
      let allAdminData = [];
      let currentAdminFilter = "all";
      let searchAdminQuery = "";

      // ===== ADMIN API ENDPOINTS =====
      const ADMIN_ENDPOINTS = {
        GET_ADMIN: "/api/get-admin",
        ADD_ADMIN: "/api/add-admin",
        EDIT_ADMIN: "/api/edit-admin",
        DELETE_ADMIN: "/api/delete-admin",
      };

      // ===== ADMIN FUNCTIONS =====
      async function loadAdmin() {
        setTableLoading("admin-table", true);

        try {
          const response = await fetch(ADMIN_ENDPOINTS.GET_ADMIN);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          allAdminData = data || [];
          displayFilteredAdmin();
        } catch (error) {
          console.error("Error loading admin:", error);
          showToast("Gagal memuat data admin!", "error");
          allAdminData = [];
          displayFilteredAdmin();
        } finally {
          setTableLoading("admin-table", false);
        }
      }

      function filterAdmin(type) {
        currentAdminFilter = type;

        document.querySelectorAll("#admin .filter-tabs .tab").forEach((tab) => {
          tab.classList.remove("active");
        });

        event.target.classList.add("active");
        displayFilteredAdmin();
      }

      function filterAdminData(data) {
        switch (currentAdminFilter) {
          case "active":
            return data.filter((item) => item.nama && item.email);
          default:
            return data;
        }
      }

      function searchAdmin(data, query) {
        if (!query || query.length === 0) return data;

        return data.filter((item) => {
          const searchableFields = [item.nama || "", item.email || ""];

          const searchableText = searchableFields.join(" ").toLowerCase();
          const queryWords = query.split(" ").filter((word) => word.length > 0);

          return queryWords.every((word) => searchableText.includes(word));
        });
      }

      function displayFilteredAdmin() {
        const tbody = document.querySelector("#admin-table tbody");
        const searchStats = document.getElementById("searchAdminStats");

        if (!tbody) return;

        let filteredData = filterAdminData(allAdminData);

        if (searchAdminQuery && searchAdminQuery.length > 0) {
          filteredData = searchAdmin(filteredData, searchAdminQuery);
        }

        tbody.innerHTML = "";

        if (filteredData.length === 0) {
          const noResultsMessage = searchAdminQuery
            ? `Tidak ditemukan admin yang sesuai dengan "${searchAdminQuery}"`
            : "Tidak ada admin untuk filter yang dipilih";

          tbody.innerHTML = `
      <tr>
        <td colspan="5" class="no-results">
          <div class="no-results-icon">üë§</div>
          <div>${noResultsMessage}</div>
        </td>
      </tr>
    `;

          updateAdminSearchStats(searchStats, 0, allAdminData.length);
          return;
        }

        filteredData.forEach((row) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
      <td>${row.id_admin}</td>
      <td title="${row.nama}">${highlightText(row.nama, searchAdminQuery)}</td>
      <td title="${row.email}">${highlightText(
            row.email,
            searchAdminQuery
          )}</td>
      <td>${formatDate(row.created_at)}</td>
      <td>
        <button onclick='editAdmin(${JSON.stringify(row).replace(
          /'/g,
          "&#39;"
        )})' class="btn btn-warning">Edit</button>
        <button onclick='deleteAdmin(${
          row.id_admin
        })' class="btn btn-danger">Hapus</button>
      </td>
    `;
          tbody.appendChild(tr);
        });

        updateAdminSearchStats(
          searchStats,
          filteredData.length,
          allAdminData.length
        );
      }

      function showTambahAdmin() {
        document.getElementById("tambahAdminForm").classList.remove("hidden");
        document.getElementById("editAdminForm").classList.add("hidden");

        setTimeout(() => {
          document.getElementById("tambahAdminForm").scrollIntoView({
            behavior: "smooth",
            block: "start",
          });
        }, 100);
      }

      function cancelTambahAdmin() {
        document.getElementById("tambahAdminForm").classList.add("hidden");
        document
          .getElementById("tambahAdminForm")
          .querySelector("form")
          .reset();
      }

      async function submitTambahAdmin(e) {
        e.preventDefault();
        const submitBtn = e.target.querySelector('button[type="submit"]');
        setButtonLoading(submitBtn, true, "Menambahkan...");

        const formData = {
          nama: document.getElementById("admin-nama").value,
          email: document.getElementById("admin-email").value,
          password: document.getElementById("admin-password").value,
        };

        try {
          const response = await fetch(ADMIN_ENDPOINTS.ADD_ADMIN, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(formData),
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          showToast("Admin berhasil ditambahkan!", "success");
          cancelTambahAdmin();
          loadAdmin();
        } catch (error) {
          console.error("Error adding admin:", error);
          showToast("Gagal menambahkan admin!", "error");
        } finally {
          setButtonLoading(submitBtn, false);
        }
      }

      function editAdmin(data) {
        document.getElementById("tambahAdminForm").classList.add("hidden");
        document.getElementById("editAdminForm").classList.remove("hidden");

        document.getElementById("edit-admin-id").value = data.id_admin;
        document.getElementById("edit-admin-nama").value = data.nama;
        document.getElementById("edit-admin-email").value = data.email;
        document.getElementById("edit-admin-password").value = "";

        setTimeout(() => {
          document.getElementById("editAdminForm").scrollIntoView({
            behavior: "smooth",
            block: "start",
          });
        }, 100);
      }

      function cancelEditAdmin() {
        document.getElementById("editAdminForm").classList.add("hidden");
      }

      async function submitEditAdmin(e) {
        e.preventDefault();
        const submitBtn = e.target.querySelector('button[type="submit"]');
        setButtonLoading(submitBtn, true, "Menyimpan...");

        const id = document.getElementById("edit-admin-id").value;
        const data = {
          id_admin: parseInt(id),
          nama: document.getElementById("edit-admin-nama").value,
          email: document.getElementById("edit-admin-email").value,
        };

        const password = document.getElementById("edit-admin-password").value;
        if (password && password.length > 0) {
          data.password = password;
        }

        try {
          const response = await fetch(ADMIN_ENDPOINTS.EDIT_ADMIN, {
            method: "PATCH",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(data),
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          showToast("Admin berhasil diupdate!", "success");
          cancelEditAdmin();
          loadAdmin();
        } catch (error) {
          console.error("Error updating admin:", error);
          showToast("Gagal mengupdate admin!", "error");
        } finally {
          setButtonLoading(submitBtn, false);
        }
      }

      async function deleteAdmin(id) {
        if (!confirm("Yakin ingin menghapus admin ini?")) return;

        const deleteBtn = event.target;
        setButtonLoading(deleteBtn, true, "Menghapus...");

        try {
          const response = await fetch(ADMIN_ENDPOINTS.DELETE_ADMIN, {
            method: "DELETE",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ id_admin: parseInt(id) }),
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          showToast("Admin berhasil dihapus!", "success");
          loadAdmin();
        } catch (error) {
          console.error("Error deleting admin:", error);
          showToast("Gagal menghapus admin!", "error");
        } finally {
          setButtonLoading(deleteBtn, false);
        }
      }

      // ===== ADMIN SEARCH FUNCTIONS =====
      function initAdminSearch() {
        const searchInput = document.getElementById("searchAdminInput");
        const searchClear = document.getElementById("searchAdminClear");

        if (!searchInput || !searchClear) return;

        searchInput.addEventListener("input", handleAdminSearchInput);
        searchClear.style.display = "none";
      }

      const handleAdminSearchInput = debounce(function (event) {
        searchAdminQuery = event.target.value.toLowerCase().trim();
        const searchClear = document.getElementById("searchAdminClear");

        if (searchAdminQuery.length > 0) {
          searchClear.style.display = "block";
        } else {
          searchClear.style.display = "none";
        }

        displayFilteredAdmin();
      }, 300);

      function clearAdminSearch() {
        const searchInput = document.getElementById("searchAdminInput");
        const searchClear = document.getElementById("searchAdminClear");
        const searchStats = document.getElementById("searchAdminStats");

        if (searchInput) searchInput.value = "";
        if (searchClear) searchClear.style.display = "none";
        if (searchStats) searchStats.textContent = "";

        searchAdminQuery = "";
        displayFilteredAdmin();
      }

      function updateAdminSearchStats(searchStats, totalResults, totalData) {
        if (!searchStats) return;

        if (searchAdminQuery && searchAdminQuery.length > 0) {
          searchStats.textContent = `Menampilkan ${totalResults} dari ${totalData} admin`;
        } else {
          searchStats.textContent = "";
        }
      }

      // ===== KETERSEDIAAN RUANGAN =====
let roomTimelineChart = null;
let currentKetersediaanDate = new Date();

async function loadKetersediaan() {
  await loadRuangan();
  await updateKetersediaan();
}

async function loadRuangan() {
  try {
    const response = await fetch('/api/get-ruangan');
    if (!response.ok) throw new Error('Failed to fetch rooms');
    const ruangan = await response.json();
    return ruangan;
  } catch (error) {
    console.error('Error loading ruangan:', error);
    showToast('Gagal memuat data ruangan!', 'error');
    return [];
  }
}

async function updateKetersediaan() {
  const dateSelect = document.getElementById('ketersediaanDate').value;
  const customDateInput = document.getElementById('customDate');
  
  // Handle date selection
  if (dateSelect === 'custom') {
    customDateInput.style.display = 'block';
    if (customDateInput.value) {
      currentKetersediaanDate = new Date(customDateInput.value);
    }
  } else {
    customDateInput.style.display = 'none';
    currentKetersediaanDate = new Date();
    if (dateSelect === 'tomorrow') {
      currentKetersediaanDate.setDate(currentKetersediaanDate.getDate() + 1);
    }
  }
  
  await renderRoomAvailability();
  await renderRoomTimeline();
}

async function renderRoomAvailability() {
  const grid = document.getElementById('roomAvailabilityGrid');
  grid.innerHTML = '<div style="text-align: center; padding: 20px;">Memuat...</div>';
  
  try {
    const [ruanganData, agendaData] = await Promise.all([
      fetch('/api/get-ruangan').then(r => r.json()),
      fetch('/api/get-agenda').then(r => r.json())
    ]);
    
    const selectedDate = currentKetersediaanDate.toISOString().split('T')[0];
    const now = new Date();
    
    // Filter agenda untuk tanggal yang dipilih
    const todayAgenda = agendaData.filter(a => a.tanggal === selectedDate);
    
    // Group agenda by room
    const agendaByRoom = {};
    todayAgenda.forEach(agenda => {
      if (!agendaByRoom[agenda.id_tempat]) {
        agendaByRoom[agenda.id_tempat] = [];
      }
      agendaByRoom[agenda.id_tempat].push(agenda);
    });
    
    // Render cards
    let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">';
    
    ruanganData.forEach(room => {
      const roomAgenda = agendaByRoom[room.id_tempat] || [];
      const status = getRoomStatus(roomAgenda, now, selectedDate);
      
      html += `
        <div class="room-card ${status.class}">
          <div class="room-header">
            <div class="room-name">üè¢ ${room.nama}</div>
            <div class="room-status ${status.statusClass}">${status.text}</div>
          </div>
          <div style="font-size: 12px; color: #666; margin-bottom: 10px;">
            Kapasitas: ${room.kapasitas} orang
          </div>
          ${renderRoomSchedule(roomAgenda)}
        </div>
      `;
    });
    
    html += '</div>';
    grid.innerHTML = html;
    
  } catch (error) {
    console.error('Error rendering room availability:', error);
    grid.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545;">Gagal memuat data</div>';
  }
}

function getRoomStatus(agenda, now, selectedDate) {
  if (agenda.length === 0) {
    return {
      class: 'available',
      statusClass: 'status-available',
      text: 'Tersedia'
    };
  }
  
  const isToday = selectedDate === now.toISOString().split('T')[0];
  
  if (isToday) {
    const currentTime = now.getHours() * 60 + now.getMinutes();
    
    for (let item of agenda) {
      const timeRange = parseTimeRange(item.jam);
      if (timeRange) {
        if (currentTime >= timeRange.start && currentTime < timeRange.end) {
          return {
            class: 'occupied',
            statusClass: 'status-occupied',
            text: 'Sedang Digunakan'
          };
        }
        if (currentTime < timeRange.start && (timeRange.start - currentTime) <= 60) {
          return {
            class: 'upcoming',
            statusClass: 'status-upcoming',
            text: 'Segera Dimulai'
          };
        }
      }
    }
  }
  
  return {
    class: 'available',
    statusClass: 'status-available',
    text: 'Tersedia'
  };
}

function parseTimeRange(timeStr) {
  if (!timeStr) return null;
  
  const match = timeStr.match(/(\d{1,2})[:.:](\d{2})\s*[-‚Äì]\s*(\d{1,2})[:.:](\d{2})/);
  if (match) {
    const startHour = parseInt(match[1]);
    const startMin = parseInt(match[2]);
    const endHour = parseInt(match[3]);
    const endMin = parseInt(match[4]);
    
    return {
      start: startHour * 60 + startMin,
      end: endHour * 60 + endMin,
      startStr: `${match[1].padStart(2, '0')}:${match[2]}`,
      endStr: `${match[3].padStart(2, '0')}:${match[4]}`
    };
  }
  return null;
}

function renderRoomSchedule(agenda) {
  if (agenda.length === 0) {
    return '<div class="empty-schedule">‚úì Tidak ada jadwal</div>';
  }
  
  let html = '<div class="room-schedule">';
  agenda.forEach(item => {
    const timeRange = parseTimeRange(item.jam);
    html += `
      <div class="schedule-item">
        <div class="schedule-time">üïê ${timeRange ? `${timeRange.startStr} - ${timeRange.endStr}` : item.jam}</div>
        <div class="schedule-agenda">${item.agenda}</div>
        <div class="schedule-pic">üë§ ${item.pic || 'Tidak ada PIC'}</div>
      </div>
    `;
  });
  html += '</div>';
  return html;
}

async function renderRoomTimeline() {
  const ctx = document.getElementById('roomTimelineChart');
  if (!ctx) return;
  
  if (roomTimelineChart) {
    roomTimelineChart.destroy();
  }
  
  try {
    const [ruanganData, agendaData] = await Promise.all([
      fetch('/api/get-ruangan').then(r => r.json()),
      fetch('/api/get-agenda').then(r => r.json())
    ]);
    
    const selectedDate = currentKetersediaanDate.toISOString().split('T')[0];
    const todayAgenda = agendaData.filter(a => a.tanggal === selectedDate);
    
    // Prepare timeline data
    const hours = Array.from({length: 13}, (_, i) => i + 7); // 7 AM to 7 PM
    const datasets = [];
    
    ruanganData.forEach((room, idx) => {
      const roomAgenda = todayAgenda.filter(a => a.id_tempat === room.id_tempat);
      const occupancy = hours.map(hour => {
        const timeInMinutes = hour * 60;
        return roomAgenda.some(agenda => {
          const range = parseTimeRange(agenda.jam);
          return range && timeInMinutes >= range.start && timeInMinutes < range.end;
        }) ? 1 : 0;
      });
      
      datasets.push({
        label: room.nama,
        data: occupancy,
        backgroundColor: `hsla(${idx * 60}, 70%, 60%, 0.6)`,
        borderColor: `hsla(${idx * 60}, 70%, 50%, 1)`,
        borderWidth: 2,
        stepped: true
      });
    });
    
    roomTimelineChart = new Chart(ctx.getContext('2d'), {
      type: 'line',
      data: {
        labels: hours.map(h => `${h}:00`),
        datasets: datasets
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: `Timeline Penggunaan - ${formatDate(selectedDate)}`
          },
          legend: {
            position: 'bottom'
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            max: 1,
            ticks: {
              stepSize: 1,
              callback: function(value) {
                return value === 1 ? 'Terpakai' : 'Tersedia';
              }
            }
          }
        }
      }
    });
    
  } catch (error) {
    console.error('Error rendering timeline:', error);
  }
}

function refreshKetersediaan() {
  updateKetersediaan();
  showToast('Data diperbarui!', 'success');
}
    </script>
  </body>
</html>
